
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<script src="jscheck.js"></script>
<style>body {
  background:rgb(200,200,200);
  user-select: none;
  touch-action: none;
  -webkit-user-select: none;
}
body.move {
  background:rgb(175, 175, 175);
}
div.menu {
  position: absolute;
  top: 0px;
  padding-left: 1em;
  z-index: 5;
}
</style>
</head>
<body>

<script src="https://www.t3puzzle.com/b/buffer.js"></script>
<script src="https://www.t3puzzle.com/b/writeMetadata.js"></script>
<script>
  let APP = {
    name: 't3p',
    type: 'gridpuzzle'
  };
  APP.restored = localStorage.getItem(APP.name + '__DATA__LASTMODIFIED');
</script>
<div class="menu">
  
  <button-text text="üîô" size="40px" onclick="historyback();">
  </button-text>
  <button-text text="‚úó" size="40px" onclick="clearall();">
  </button-text>
  <switch-text onchange="t3puzzle.setAttribute('color',this.value)" value="blue" size="40px">
    <datalist>
      <option value="blue"></option>
      <option value="green"></option>
      <option value="pink"></option>
      <option value="mint"></option>
    </datalist>
  </switch-text>
  <button-text text="‚û∞" onclick="t3puzzle.setAttribute('flipall','');" size="40px">
  </button-text>

  <button-text text="‚åñ" onclick="t3puzzle.setAttribute('fit','');" size="40px">
  </button-text>
 <div class="ui__pc">
  <button-text text="üîç" onclick="zoom();" size="20px">
  </button-text>
  <button-text text="‚§ø" onclick="rotate();" size="40px">
  </button-text>
  </div>

  <button-text text="‚Üë‚éµ" onclick="dialogopen(
                                  'upload',
                                  dialog__form__modal,
                                  dialog__t3work, 
                                  dialog__form,
                                  UPLOAD)" size="40px">
  </button-text>
  <button-text text="üìñ" onclick="dialogopen(
                                  'load',
                                  load__form__modal,
                                  load__t3work, 
                                  load__form,
                                  LOAD)" size="40px">
  </button-text>
</div>
<grid-puzzle style="margin-left:0px;" id="t3puzzle" mode="hand" onChange="processData(this.value)">
  <datalist>
    <grid-data>{
      "orientation":2.0919229374524506,"tiles":[[0,-3,1,1,1,0,0],[0,-1,1,1,0,0,0]]
      }
    </grid-data>
  </datalist>
</grid-puzzle>

<dialog-modal id="dialog__form__modal">
  <template>
    <div id="dialog__src" style="margin-left:0px;width:320px;height:320px; background: rgb(200, 200, 200);"></div>
    <grid-puzzle style="margin-left:0px;" id="dialog__t3work" width="320px" height="320px" mode="readonly" for="dialog__src">
      <datalist>
        <grid-data>{"tiles":[]}
        </grid-data>
      </datalist>
    </grid-puzzle> 
    <img id="dialog__img" style="display:none;" width="320px" height="320px">
    <div style="width:100%;height:90%;margin: 3px;text-align: center;">
      <div class="ui__pc">
        <button-text text="‚§ø" onclick="rotate(dialog__t3work);" size="20px">
        </button-text>

        <button-text text="üîç" onclick="zoom(dialog__t3work);" size="20px">
        </button-text>

        <button-text text="‚åñ" onclick="dialog__t3work.setAttribute('fit','');" size="20px">
        </button-text>
      </div>
      <form id="dialog__form" action="#" style="text-align:left;" onsubmit="submitImage(dialog__src,dialog__form, UPLOAD);return false;">
        <input name="artist" type="hidden">
        <input name="data" type="hidden">
        <input name="filename" type="hidden">
        <input name="type" value="image/png" type="hidden">
        <input name="content" type="hidden">
        <input id="dialog__meta" name="meta" type="hidden">
        <label for="dialog__age">„Å≠„Çì„Çå„ÅÑ:</label>
        <input required id="dialog__age" name="age" value="" type="number" min="0" max="150" style="width:35px;">
        <div style="display:inline-block;margin-top:10px;border-width:1px;">
          <input class="submit" type="submit" value="„Åª„Åû„Çì„Åô„Çã" style="background:#4676FF;-webkit-appearance: none;color:white;border-radius: 5px;border-width:0px;font-size:110%;">
        </div>
        <br /><input required placeholder="„Å†„ÅÑ„ÇÅ„ÅÑ" name="title" type="text" style="width:305px;margin-top:3px;border-width:1px;" onchange="UPLOAD.title = this.value;">
        <br /><input placeholder="„Ç≥„É≥„ÉÜ„Çπ„Éà„Åä„ÅÜ„Åº‚Üí„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÂÖ•Âäõ" name="email" type="email" style="width:305px;margin-top:3px;border-width:1px;" onchange="if(!/^[a-zA-Z0-9\.\+-@_]+$/.test(this.value)){this.value='';}this.form.querySelector('input.submit').value=(this.value.trim())?'„Åä„ÅÜ„Åº„Åô„Çã':'„Åª„Åû„Çì„Åô„Çã';">
        <textarea placeholder="„Åè„Åµ„ÅÜ„Åó„Åü„Åì„Å®„ÄÄ&#010;‰øùÂ≠ò„Åó„Åü‰ΩúÂìÅ„Åä„Çà„Å≥Ë®òÂÖ•ÂÜÖÂÆπ„ÅØÂÖ¨Èñã„Åï„Åõ„Å¶„ÅÑ„Åü„Å†„Åè„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô" name="note" rows="3" onchange="UPLOAD.note = this.value;" style="width:305px;margin-top:3px;display:block;font-size:90%;border-width:1px;"></textarea>
      </form>
  </template>
</dialog-modal>

<dialog-modal id="load__form__modal">
  <template>
    <div id="load__src" style="width:320px;height:320px; background: rgb(200, 200, 200);"></div>
    <grid-puzzle style="margin-left:0px;" id="load__t3work" width="320px" height="320px" mode="readonly" for="load__src">
      <datalist>
        <grid-data>{"tiles":[]}
        </grid-data>
      </datalist>
    </grid-puzzle>
    <div style="width:100%;height:90%;margin: 0px;text-align: center;">

    </div>
    <form id="load__form" action="#" style="text-align:left;" onsubmit="loadDataToMain(load__form__modal);return false;">
      <input name="artist" type="hidden">
      <input name="data" type="hidden">
      <input name="filename" type="hidden">
      <input name="type" value="image/png" type="hidden">
      <input id="load_meta" name="meta" type="hidden">
      <input name="content" type="hidden">
      <input id="load__age" name="age" type="hidden" min="0" max="150" style="width:35px;">
      <div style="display:inline-block;border-width:1px;">
        <div id="load__history" style="display:inline-block;">
          <button-text text="¬´" onclick="gohead(load__t3work,load__form);" size="30px">
          </button-text>
          <button-text text="‚Äπ" onclick="backward(load__t3work,load__form);" size="30px">
          </button-text>
          <div id="load__number" style="display:inline-block;"></div>

          <button-text text="‚Ä∫" onclick="forward(load__t3work,load__form);" size="30px">
          </button-text>
          <button-text text="¬ª" onclick="goend(load__t3work,load__form);" size="30px">
          </button-text>
        </div>
        <input type="submit" value="„ÅØ„Åò„ÇÅ„Çã" style="background:#46cc76;-webkit-appearance: none;color:white;border-radius: 5px;border-width:0px;font-size:110%;display:inline-block;">
      </div>
      <br />
      <input readonly id="load__title" name="title" type="text" style="width:305px;margin-top:3px;border-width:1px;">
      <textarea readonly name="note" rows="4" style="width:305px;margin-top:3px;display:block;font-size:90%;border-width:1px;"></textarea>
    </form>
  </template>
</dialog-modal>

</div>
<script>
  let HISTORY = {
    status: '',
    back: ''
  };

  function putmeta(str) {
    if (!str) {
      return;
    }
    let json = JSON.parse(str);
    if (!('meta' in json)) {
      return;
    }
    localStorage.setItem(APP.name + '__meta__LASTLOADED', JSON.stringify(json.meta));
  }

  function setmeta() {
    let value = localStorage.getItem(APP.name + '__meta__LASTLOADED');
    if (value) {
      dialog__meta.value = value;
    }
  }

  function loadInitData() {
    let str = APP.restored;
    if (str) {
      t3puzzle.setAttribute('loaddata', str);
      setmeta();
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    loadInitData();
    bodyMovePrevent();
    if (('ontouchend' in document)) {
      Array.from(document.querySelectorAll('.ui__pc')).map(u => {
        u.style['display'] = 'none';
      });
    }
    loadPreset();
    /////
    fetch_initdata();
    ///////
  });
  let UPLOAD = {
    imageNode: null,
    lastImageNode: null,
    submitMessage: '',
    submitEvent: '',
    title: '',
    note: '',
    url: 'https://script.google.com/a/tessellation.jp/macros/s/AKfycbzNfVfpZuYhGT6XZ_0ElgV0ASYb2_Th1qOOjvBWUWssEPBGm3fM/exec'
  }
  let LOAD = {
    imageNode: null,
    lastImageNode: null,
    submitMessage: '',
    submitEvent: '',
    url: UPLOAD.url,
    pointer: null,
    preset: 0,
  }

  function loadPreset() {
    let count = -1;
    localStorage.setItem(APP.name + '__MIN', count);
    localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
      'meta': {
        'id': 'preset' + count,
        'base': '',
        'origin': '',
        artist: '_',
        'title': 'T3',
        'note': 'T3„Éë„Ç∫„É´„ÅÆ„É≠„Ç¥„Çí„Å§„Åè„Çä„Åæ„Åó„Åü'
      },
      'orientation': 3.1415855821521044,
      'tiles': [
        [2, 0, 0, 1, 0, 0, 0],
        [2, 0, 1, 1, 1, 0, 0],
        [2, 1, 0, 0, 1, 0, 0],
        [1, 1, 0, 0, 1, 0, 0],
        [2, 1, 1, 0, 0, 0, 0],
        [2, -1, 1, 1, 1, 0, 0],
        [2, -1, 0, 1, 0, 0, 0],
        [1, -1, 0, 1, 1, 0, 0],
        [1, -1, 1, 1, 0, 0, 0],
        [1, 0, 1, 1, 0, 0, 0],
        [1, 0, 0, 1, 1, 0, 0],
        [1, 1, 1, 0, 0, 0, 0],
        [0, 1, 0, 1, 0, 0, 0],
        [0, 1, 1, 0, 0, 0, 0],
        [-1, 1, 0, 0, 1, 0, 0],
        [-1, 0, 1, 1, 1, 0, 0],
        [-1, 0, 0, 0, 1, 0, 0],
        [-1, -1, 1, 1, 1, 0, 0],
        [-1, -1, 0, 0, 1, 0, 0],
        [0, -1, 0, 1, 0, 0, 0],
        [0, -1, 1, 0, 0, 0, 0],
        [0, 0, 0, 1, 0, 0, 0],
        [0, 0, 1, 0, 0, 0, 0],
        [-1, 1, 1, 0, 0, 0, 0]
      ]
    }));
    ///
    count--;
    localStorage.setItem(APP.name + '__MIN', count);
    localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
      'meta': {
        'id': 'preset' + count,
        'base': '',
        'origin': '',
        artist: '_',
        'title': '„Ç´„Éñ„Éà„É†„Ç∑',
        'note': '„Å™„Å§„ÇÑ„Åô„Åø„ÅÆ„Åä„ÇÇ„ÅÑ„Åß„Åß„Ç´„Éñ„Éà„É†„Ç∑„Çí„Åã„Åç„Åæ„Åó„Åü'
      },
      'orientation': -2.0944014018871053,
      'tiles': [
        [2, 0, 0, 0, 1, 2, 0],
        [2, 0, 1, 1, 1, 2, 0],
        [2, -1, 1, 2, 1, 2, 0],
        [2, -1, 0, 1, 1, 2, 0],
        [1, -1, 0, 0, 1, 2, 0],
        [1, -1, 1, 2, 1, 2, 0],
        [1, 0, 0, 1, 1, 2, 0],
        [2, 1, 0, 1, 0, 2, 0],
        [1, 0, 1, 1, 0, 2, 0],
        [1, -2, 0, 1, 0, 2, 0],
        [2, -2, 1, 1, 0, 2, 0],
        [1, -2, 1, 1, 1, 2, 0],
        [2, 2, 0, 2, 0, 2, 0],
        [2, 1, 1, 2, 1, 2, 0],
        [1, 1, 0, 0, 1, 2, 0],
        [1, 1, 1, 0, 0, 2, 0],
        [0, -3, 0, 2, 1, 2, 0],
        [1, -3, 1, 0, 1, 2, 0],
        [2, -3, 1, 2, 0, 2, 0],
        [2, -2, 0, 2, 1, 2, 0],
        [1, -3, 0, 0, 0, 2, 0],
        [0, -4, 1, 1, 1, 2, 0],
        [3, -2, 1, 0, 1, 2, 0],
        [3, -2, 0, 1, 1, 2, 0],
        [3, 0, 1, 2, 1, 2, 0],
        [3, 1, 0, 1, 1, 2, 0],
        [0, -1, 0, 0, 1, 2, 0],
        [0, -1, 1, 1, 1, 2, 0],
        [0, -2, 0, 2, 1, 2, 0],
        [3, -1, 1, 0, 1, 2, 0],
        [3, -1, 0, 0, 0, 2, 0],
        [0, -3, 1, 2, 0, 2, 0]
      ]
    }));
    ///
    count--;
    localStorage.setItem(APP.name + '__MIN', count);
    localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
      'meta': {
        'id': 'preset' + count,
        'base': '',
        'origin': '',
        artist: '_',
        'title': '„É©„Ç∏„Ç™‰ΩìÊìç',
        'note': 'Â§è‰ºë„Åø„Å´„É©„Ç∏„Ç™‰ΩìÊìç„Çí„Åó„ÅüÊÄù„ÅÑÂá∫„Çí„Åã„Åç„Åæ„Åó„Åü'
      },
      'orientation': -2.0944014018871053,
      'tiles': [
        [2, 0, 0, 0, 1, 2, 0],
        [2, 0, 1, 0, 0, 2, 0],
        [2, -1, 1, 1, 1, 2, 0],
        [2, -1, 0, 1, 0, 2, 0],
        [1, -1, 1, 0, 1, 2, 0],
        [1, 0, 0, 0, 1, 2, 0],
        [1, 0, 1, 1, 1, 2, 0],
        [1, 1, 1, 0, 0, 2, 0],
        [1, -3, 0, 0, 0, 2, 0],
        [3, 0, 1, 0, 0, 2, 0],
        [0, -1, 0, 1, 1, 2, 0],
        [0, -1, 1, 0, 1, 2, 0],
        [4, 0, 0, 2, 1, 2, 0],
        [3, 0, 0, 0, 1, 2, 0],
        [4, 0, 1, 0, 0, 2, 0],
        [2, -2, 1, 1, 1, 2, 0],
        [2, -2, 0, 1, 0, 2, 0],
        [2, -3, 1, 2, 0, 2, 0],
        [1, -1, 0, 2, 1, 2, 0],
        [0, 0, 0, 0, 1, 2, 0],
        [1, 1, 0, 1, 0, 2, 0],
        [0, 1, 0, 0, 1, 2, 0],
        [0, 0, 1, 2, 0, 2, 0],
        [-1, 0, 0, 0, 0, 2, 0],
        [0, -2, 1, 1, 0, 2, 0],
        [0, -2, 0, 0, 0, 2, 0],
        [1, -2, 1, 2, 0, 2, 0]
      ]
    }));
    ///
    count--;
    localStorage.setItem(APP.name + '__MIN', count);
    localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
      'meta': {
        'id': 'preset' + count,
        'base': '',
        'origin': '',
        artist: '_',
        'title': '‰ª§ÂíåÔºà„Çå„ÅÑ„ÇèÔºâ',
        'note': 'ÂÖÉÂè∑„ÅÆÂ§â„Çè„ÇäÁõÆ„Å´„Åã„Åç„Åæ„Åó„Åü'
      },
      "orientation": -2.6180020411703095,
      "tiles": [
        [0, 0, 1, 2, 1, 0, 0],
        [0, 1, 0, 0, 0, 0, 0],
        [0, 1, 1, 0, 1, 0, 0],
        [-1, 1, 0, 2, 1, 0, 0],
        [-1, 0, 1, 2, 0, 0, 0],
        [-2, 0, 0, 2, 1, 0, 0],
        [-1, 0, 0, 0, 1, 0, 0],
        [0, 0, 0, 0, 1, 0, 0],
        [0, -1, 1, 1, 1, 0, 0],
        [-1, -1, 1, 1, 1, 0, 0],
        [-1, -1, 0, 1, 0, 0, 0],
        [-1, -2, 1, 1, 1, 0, 0],
        [-1, -2, 0, 2, 1, 0, 0],
        [0, -1, 0, 1, 0, 0, 0],
        [0, -2, 1, 1, 1, 0, 0],
        [-2, -1, 0, 0, 1, 1, 0],
        [-2, -1, 1, 0, 0, 1, 0],
        [-3, -1, 0, 0, 1, 1, 0],
        [-2, -2, 1, 1, 1, 1, 0],
        [-2, -2, 0, 0, 1, 1, 0],
        [-2, -3, 1, 1, 1, 1, 0],
        [-3, -2, 0, 0, 1, 1, 0],
        [-2, -3, 0, 0, 1, 1, 0],
        [-1, -3, 1, 0, 0, 1, 0],
        [-2, -4, 1, 1, 1, 1, 0],
        [-3, -3, 1, 1, 1, 1, 0],
        [-3, -3, 0, 2, 1, 1, 0],
        [-3, -2, 1, 0, 0, 1, 0],
        [-4, -2, 0, 2, 0, 1, 0],
        [-4, -3, 1, 2, 1, 1, 0],
        [-4, -3, 0, 1, 0, 1, 0],
        [-4, -4, 1, 1, 1, 1, 0],
        [-4, -4, 0, 1, 0, 1, 0],
        [-4, -5, 1, 0, 1, 1, 0],
        [-4, -5, 0, 0, 0, 1, 0],
        [-3, -5, 1, 2, 0, 1, 0],
        [-3, -4, 1, 1, 1, 1, 0],
        [-3, -4, 0, 1, 0, 1, 0]
      ]
    }));
    ///
    count--;
    localStorage.setItem(APP.name + '__MIN', count);
    localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
      'meta': {
        'id': 'preset' + count,
        'base': '',
        'origin': '',
        artist: '_',
        'title': '„Åã„Åä',
        'note': 'ÁõÆ„ÇÑÂè£„ÅÆ„Åã„Åü„Å°„Çí„Åã„Åà„Å¶„ÅÑ„Çç„Çì„Å™Ë°®ÊÉÖ„Çí„Å§„Åè„Çç„ÅÜ'
      },
      "orientation": -2.6180001200192566,
      "tiles": [
        [0, 0, 1, 2, 0, 0, 0],
        [0, 1, 0, 2, 1, 0, 0],
        [0, 1, 1, 2, 0, 0, 0],
        [1, 1, 1, 2, 0, 0, 0],
        [0, 0, 0, 2, 1, 0, 0],
        [0, -1, 1, 2, 0, 0, 0],
        [1, 0, 1, 2, 0, 0, 0],
        [1, 1, 0, 2, 1, 0, 0],
        [1, 2, 0, 1, 0, 0, 0],
        [0, 2, 0, 0, 0, 0, 0],
        [-1, 1, 0, 0, 0, 0, 0],
        [0, 2, 1, 1, 0, 0, 0],
        [0, 3, 0, 2, 0, 0, 0],
        [1, 2, 1, 2, 0, 0, 0],
        [1, 3, 0, 1, 0, 0, 0],
        [1, 3, 1, 0, 0, 0, 0],
        [-1, 2, 0, 1, 0, 0, 0],
        [-1, 2, 1, 0, 0, 0, 0],
        [-2, 2, 0, 2, 0, 0, 0],
        [-2, 1, 1, 1, 0, 0, 0],
        [-2, 1, 0, 0, 0, 0, 0],
        [-1, 1, 1, 2, 0, 0, 0],
        [-1, 0, 0, 0, 0, 0, 0],
        [-1, 0, 1, 0, 1, 0, 0],
        [-2, 0, 0, 0, 0, 0, 0],
        [-2, 0, 1, 1, 0, 0, 0],
        [-1, -1, 0, 0, 0, 0, 0],
        [-2, -1, 0, 0, 0, 0, 0],
        [-1, -1, 1, 0, 1, 0, 0],
        [-3, -1, 0, 0, 0, 0, 0],
        [-2, -1, 1, 0, 1, 0, 0],
        [-3, -1, 1, 1, 0, 0, 0],
        [-3, 0, 1, 1, 0, 0, 0],
        [-3, 0, 0, 1, 1, 0, 0],
        [2, 1, 1, 2, 0, 0, 0],
        [2, 2, 0, 1, 0, 0, 0],
        [2, 2, 1, 1, 1, 0, 0],
        [2, 3, 0, 1, 0, 0, 0],
        [2, 3, 1, 2, 1, 0, 0],
        [-3, 1, 0, 0, 1, 0, 0],
        [-3, 1, 1, 1, 1, 0, 0],
        [-3, 2, 0, 1, 0, 0, 0],
        [-2, 2, 1, 0, 0, 0, 0],
        [2, 4, 0, 1, 1, 0, 0],
        [1, 4, 0, 2, 0, 0, 0],
        [-1, 3, 0, 0, 0, 0, 0],
        [0, 3, 1, 2, 0, 0, 0],
        [-1, 3, 1, 2, 1, 0, 0],
        [-2, 3, 0, 0, 1, 0, 0],
        [0, 4, 0, 0, 1, 0, 0],
        [1, 4, 1, 2, 1, 0, 0],
        [2, 4, 1, 1, 0, 0, 0],
        [-1, 4, 0, 2, 0, 0, 0],
        [0, 4, 1, 0, 0, 0, 0],
        [2, 5, 0, 1, 1, 0, 0],
        [1, 5, 0, 1, 1, 0, 0],
        [2, 5, 1, 0, 1, 0, 0],
        [-3, 2, 1, 1, 1, 0, 0],
        [-3, 3, 0, 2, 1, 0, 0],
        [-2, 3, 1, 1, 1, 0, 0],
        [-2, 4, 0, 1, 0, 0, 0],
        [1, 5, 1, 1, 0, 0, 0]
      ]
    }));
    ///
    count--;
    localStorage.setItem(APP.name + '__MIN', count);
    localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
      'meta': {
        'id': 'preset' + count,
        'base': '',
        'origin': '',
        artist: '_',
        'title': '„Çπ„Éé„Éº„Éû„É≥',
        'note': 'Èõ™„Å†„Çã„Åæ„Å§„Åè„Çç„ÉºÔºÅ'
      },
      "orientation":2.0919227792078106,"tiles":[[0,-3,1,0,0,0,0],[0,-3,0,0,1,0,0],[1,-3,1,0,0,0,0],[1,-3,0,2,1,0,0],[2,-2,0,2,1,0,0],[3,-2,1,0,1,0,0],[3,-2,0,0,0,0,0],[4,-2,1,2,0,0,0],[2,-3,0,0,1,1,0],[2,-3,1,1,1,1,0],[2,-4,1,1,1,1,0],[1,-4,0,2,1,1,0],[4,-1,0,1,1,1,0],[4,-1,1,1,0,1,0],[3,-1,0,1,1,3,0],[3,-1,1,1,0,3,0],[3,0,0,2,0,3,0],[4,0,1,0,0,3,0],[1,-2,1,1,0,3,0],[1,-2,0,1,0,3,0],[1,-1,0,1,0,3,0],[0,-2,1,2,0,0,0],[0,-2,0,1,0,3,0],[0,-1,0,2,1,0,0],[1,-1,1,2,0,0,0],[1,0,0,0,1,0,0],[2,0,0,0,1,0,0],[3,0,1,2,1,0,0],[3,1,0,2,0,0,0],[4,1,1,2,1,0,0],[5,1,1,0,1,0,0],[4,1,0,0,0,0,0],[2,-2,1,1,0,3,0],[2,-1,0,1,1,3,0],[2,-1,1,1,0,3,0],[5,0,1,2,0,2,0],[4,0,0,0,0,2,0],[5,-1,1,2,0,2,0],[5,0,0,2,0,0,0],[6,0,1,1,1,0,0],[6,1,1,1,1,0,0],[6,2,0,1,0,0,0],[5,1,0,0,0,0,0],[6,1,0,2,1,2,0],[7,1,1,2,0,2,0],[7,2,0,2,1,2,0],[7,2,1,1,0,2,0],[7,3,0,1,1,2,0],[7,3,1,0,1,2,0],[6,3,0,2,1,2,0],[6,2,1,2,0,2,0],[5,2,0,2,1,2,0],[2,0,1,1,1,1,0],[2,1,0,2,1,1,0],[2,1,1,1,1,1,0],[1,1,0,0,1,1,0]]
    }));
    ///
    count--;
    localStorage.setItem(APP.name + '__MIN', count);
    localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
      'meta': {
        'id': 'preset' + count,
        'base': '',
        'origin': '',
        artist: '_',
        'title': '„Å≤„Åó„Å™„Çâ„Åπ',
        'note': 'T3„Éë„Ç∫„É´„Çí„Å§„Åã„Å£„Åü„ÅÇ„Åù„Å≥„Åß„Åô\n„ÅÜ„Åà„ÅÆ„Çà„ÅÜ„Å™„Åä„Åä„Åç„Å™„Å≤„Åó„Åå„Åü„Çí„Å§„Åè„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ„Åü„Å†„Åó„ÄÅ„Åó„Åü„ÅÆÔºò„Å§„ÅÆ„Å°„ÅÑ„Åï„Å™„Å≤„Åó„Åå„Åü„Çí„Åµ„Åè„ÇÄ„Åì„Å®'
      },
      'orientation': 0.5235896368295516,
      'tiles': [
        [0, 0, 0, 1, 1, 0, 1],
        [1, 0, 0, 2, 1, 0, 1],
        [1, 0, 1, 1, 0, 0, 1],
        [2, 0, 1, 0, 1, 0, 1],
        [1, -1, 1, 0, 1, 0, 1],
        [0, -1, 0, 0, 0, 0, 1],
        [0, -1, 1, 1, 1, 0, 1],
        [-1, -1, 0, 1, 1, 0, 1],
        [0, 1, 1, 1, 1, 0, 1],
        [-1, 1, 0, 1, 1, 0, 1],
        [0, 2, 1, 1, 1, 0, 1],
        [-1, 2, 0, 1, 0, 0, 1],
        [2, 2, 1, 0, 1, 0, 1],
        [0, 3, 1, 1, 1, 0, 1],
        [-1, 3, 0, 0, 1, 0, 1],
        [1, 2, 0, 0, 0, 0, 1],
        [2, 3, 1, 0, 1, 0, 1],
        [1, 3, 0, 2, 0, 0, 1],
        [2, 4, 1, 2, 1, 0, 1],
        [1, 4, 0, 2, 1, 0, 1],
        [0, 4, 1, 1, 1, 0, 1],
        [-1, 4, 0, 0, 0, 0, 1],
        [2, 5, 1, 2, 1, 0, 1],
        [1, 5, 0, 0, 1, 0, 1]
      ]
    }));
    ///
    count--;
    localStorage.setItem(APP.name + '__MIN', count);
    localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
      'meta': {
        'id': 'preset' + count,
        'base': '',
        'origin': '',
        artist: '_',
        'title': '„Å≤„Åó„Å™„Çâ„Åπ(„ÅÆ„Åì„ÇäÔºí„Éî„Éº„Çπ)',
        'note': 'T3„Éë„Ç∫„É´„Çí„Å§„Åã„Å£„Åü„ÅÇ„Åù„Å≥„Åß„Åô„ÄÇ„Åó„Åü„ÅÆÔºò„Å§„ÅÆ„Å°„ÅÑ„Åï„Å™„Å≤„Åó„Åå„Åü„Çí„Åµ„Åè„ÇÄ„Çà„ÅÜ„Å´„ÄÅ„ÅÜ„Åà„ÅÆ„Åä„Åä„Åç„Å™„Å≤„Åó„Åå„Åü„Çí„Åã„Çì„Åõ„ÅÑ„Åï„Åõ„Çà„ÅÜ'
      },
      'orientation': 0.52359196882172,
      'tiles': [
        [0, 0, 0, 1, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 1],
        [2, 0, 1, 1, 0, 0, 1],
        [0, -1, 0, 2, 0, 0, 1],
        [0, -1, 1, 2, 0, 0, 1],
        [-1, -1, 0, 2, 0, 0, 1],
        [0, 1, 1, 1, 0, 0, 1],
        [-1, 1, 0, 1, 0, 0, 1],
        [0, 2, 1, 1, 0, 0, 1],
        [-1, 2, 0, 1, 1, 0, 1],
        [2, 2, 1, 2, 0, 0, 1],
        [0, 3, 1, 1, 0, 0, 1],
        [-1, 3, 0, 0, 1, 0, 1],
        [1, 2, 0, 2, 1, 0, 1],
        [2, 3, 1, 2, 0, 0, 1],
        [1, 3, 0, 0, 1, 0, 1],
        [2, 4, 1, 2, 0, 0, 1],
        [1, 4, 0, 2, 0, 0, 1],
        [0, 4, 1, 1, 0, 0, 1],
        [-1, 4, 0, 0, 0, 0, 1],
        [2, 5, 1, 2, 0, 0, 1],
        [1, 5, 0, 0, 0, 0, 1],
        [1, -1, 1, 2, 1, 0, 2],
        [1, 0, 1, 1, 1, 0, 2]
      ]
    }));
    ///
    count--;
    localStorage.setItem(APP.name + '__MIN', count);
    localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
      'meta': {
        'id': 'preset' + count,
        'base': '',
        'origin': '',
        artist: '_',
        'title': '„Åæ„Çä„Çá„ÅÜ„Åò„ÇìÔºàÈ≠îËè±Èô£Ôºâ',
        'note': '„ÅÜ„Åà„ÅÆ„Çà„ÅÜ„Å™„Äå„Å≤„Åó„Åå„Åü„Äç„Çí„Å§„Åè„Çã„Éë„Ç∫„É´„Åß„Åô„ÄÇ„Å≤„Åó„Åå„Åü„Çí4√ó4„ÅÆ„Éû„Çπ„É°„Åß„Åè„Åé„Å£„Å¶„Åã„Çì„Åå„Åà„Å¶„ÄÅ„Å©„ÅÆ„Åé„Çá„ÅÜ„ÄÅ„Çå„Å§„Å´„ÇÇ„ÅÇ„Åä„ÅÑ„Äå„Åï„Çì„Åã„Åè„Åë„ÅÑ„Äç„ÇíÔºì„Å§„Åä„Åè„Çà„ÅÜ„Å´„Å™„Çâ„Åπ„Å¶„Åè„Å†„Åï„ÅÑ'
      },
      'orientation': -2.094401552186574,
      'tiles': [
        [0, 0, 0, 2, 0, 0, 1],
        [1, 0, 0, 0, 0, 0, 1],
        [1, 0, 1, 0, 0, 0, 1],
        [2, 0, 1, 2, 1, 0, 1],
        [1, -1, 1, 2, 0, 0, 1],
        [0, -1, 0, 0, 0, 0, 1],
        [0, -1, 1, 0, 0, 0, 1],
        [-1, -1, 0, 2, 1, 0, 1],
        [3, -2, 1, 1, 0, 0, 1],
        [4, -2, 1, 1, 0, 0, 1],
        [3, -2, 0, 1, 0, 0, 1],
        [3, -3, 1, 1, 0, 0, 1],
        [2, -3, 0, 0, 1, 0, 1],
        [2, -2, 0, 0, 1, 0, 2],
        [2, -3, 1, 2, 1, 0, 2],
        [1, -3, 0, 0, 1, 0, 2]
      ]
    }));
    ///
    count--;
    localStorage.setItem(APP.name + '__MIN', count);
    localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
      'meta': {
        'id': 'preset' + count,
        'base': '',
        'origin': '',
        artist: '_',
        'title': '„ÉÅ„Çß„ÉÉ„Ç´„Éº„Å™„Çâ„Åπ',
        'note': '„ÅÜ„Åà„ÅÆ„Çà„ÅÜ„Å™„Äå„Åó„Åã„Åè„Äç„Å´„Å™„Çâ„Åπ„Çã„Éë„Ç∫„É´„Åß„Åô„ÄÇ‰∏ã„ÅÆ12„Éî„Éº„Çπ„ÅÆ„ÇÄ„Åç„Çí„Åã„Åà„Åö„Å´„ÄÅ„Å®„Å™„Çä„ÅÇ„ÅÜ„Éî„Éº„Çπ„Å®„ÅÑ„Çç„Åå„Å∂„Å§„Åã„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Äå„ÉÅ„Çß„ÉÉ„Ç´„Éº„ÇÇ„Çà„ÅÜ„Äç„ÅÆ„Çà„ÅÜ„Å´„Å™„Çâ„Åπ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
      },
      'orientation': -2.094403274190408,
      'tiles': [
        [2, -2, 1, 1, 0, 0, 1],
        [1, -2, 1, 0, 0, 0, 1],
        [1, -2, 0, 1, 1, 0, 1],
        [1, -3, 1, 2, 0, 0, 1],
        [0, -2, 0, 2, 1, 0, 1],
        [0, -3, 1, 2, 1, 0, 1],
        [0, -3, 0, 2, 0, 0, 1],
        [0, -4, 1, 1, 1, 0, 1],
        [-1, -4, 1, 0, 1, 0, 1],
        [-1, -4, 0, 1, 0, 0, 1],
        [-1, -3, 0, 0, 0, 0, 1],
        [-2, -4, 0, 0, 1, 0, 1],
        [3, -3, 1, 0, 1, 0, 1],
        [2, -4, 1, 1, 1, 0, 1],
        [1, -5, 1, 2, 0, 0, 1],
        [0, -6, 1, 0, 0, 0, 1],
        [-1, -7, 1, 1, 0, 0, 1],
        [4, -2, 1, 2, 1, 0, 1],
        [4, -3, 0, 2, 1, 0, 1],
        [3, -4, 0, 1, 1, 0, 1],
        [2, -5, 0, 0, 1, 0, 1],
        [1, -6, 0, 2, 0, 0, 1],
        [0, -7, 0, 1, 0, 0, 1],
        [-1, -8, 0, 0, 0, 0, 1]
      ]
    }));
    ///
    count--;
    localStorage.setItem(APP.name + '__MIN', count);
    localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
      'meta': {
        'id': 'preset' + count,
        'base': '',
        'origin': '',
        artist: '_',
        'title': '„ÉÅ„Çß„ÉÉ„Ç´„Éº„Å™„Çâ„ÅπÔºà„ÅÆ„Åì„Çä4„Éî„Éº„ÇπÔºâ',
        'note': '„ÅÜ„Åà„ÅÆ„Äå„Åó„Åã„Åè„Äç„ÅÆ„ÅÇ„Åä„ÅÑ„ÅÆ„Éî„Éº„Çπ„Çí„Å™„Çâ„Å≥„Åã„Åà„Å¶„ÄÅ„Å®„Å™„Çä„ÅÇ„ÅÜ„Éî„Éº„Çπ„Å®„ÅÑ„Çç„Åå„Å∂„Å§„Åã„Å™„Çâ„ÅÑ„Çà„ÅÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Åü„Å†„Åó„ÄÅ„ÅÜ„Åà„ÅÆ„Éî„Éº„Çπ„ÅØ„Å©„Çå„ÇÇ„ÄÅ„Åó„Åü„ÅÆ12„Éî„Éº„Çπ„ÅÆ„ÅÑ„Åö„Çå„Åã„Å≤„Å®„Å§„Å®„Åä„Å™„Åò„ÇÄ„Åç„Å®„Åó„Åæ„Åô„ÄÇ'
      },
      'orientation': -2.094403274190408,
      'tiles': [
        [2, -2, 1, 1, 1, 0, 1],
        [1, -2, 0, 1, 0, 0, 1],
        [1, -3, 1, 1, 0, 0, 1],
        [0, -2, 0, 0, 1, 0, 1],
        [0, -3, 1, 0, 0, 0, 1],
        [0, -3, 0, 1, 1, 0, 1],
        [-1, -4, 1, 2, 1, 0, 1],
        [-1, -4, 0, 2, 0, 0, 1],
        [3, -3, 1, 0, 1, 0, 1],
        [2, -4, 1, 1, 1, 0, 1],
        [1, -5, 1, 2, 0, 0, 1],
        [0, -6, 1, 0, 0, 0, 1],
        [-1, -7, 1, 1, 0, 0, 1],
        [4, -2, 1, 2, 1, 0, 1],
        [4, -3, 0, 2, 1, 0, 1],
        [3, -4, 0, 1, 1, 0, 1],
        [2, -5, 0, 0, 1, 0, 1],
        [1, -6, 0, 2, 0, 0, 1],
        [0, -7, 0, 1, 0, 0, 1],
        [-1, -8, 0, 0, 0, 0, 1],
        [1, -2, 1, 0, 0, 0, 2],
        [-1, -3, 0, 2, 0, 0, 2],
        [0, -4, 1, 2, 1, 0, 2],
        [-2, -4, 0, 2, 0, 0, 2]
      ]
    }));
    ///
    count--;
    localStorage.setItem(APP.name + '__MIN', count);
    localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
      'meta': {
        'id': 'preset' + count,
        'base': '',
        'origin': '',
        artist: '_',
        'title': '„ÉÅ„Çß„ÉÉ„Ç´„Éº„Å™„Çâ„ÅπÔºà„ÅÆ„Åì„Çä10„Éî„Éº„ÇπÔºâ',
        'note': '„ÅÜ„Åà„ÅÆ„Äå„Åó„Åã„Åè„Äç„ÅÆ„ÅÇ„Åä„ÅÑ„ÅÆ„Éî„Éº„Çπ„Çí„Å™„Çâ„Å≥„Åã„Åà„Å¶„ÄÅ„Å®„Å™„Çä„ÅÇ„ÅÜ„Éî„Éº„Çπ„Å®„ÅÑ„Çç„Åå„Å∂„Å§„Åã„Å™„Çâ„ÅÑ„Çà„ÅÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Åü„Å†„Åó„ÄÅ„ÅÜ„Åà„ÅÆ„Éî„Éº„Çπ„ÅØ„Å©„Çå„ÇÇ„ÄÅ„Åó„Åü„ÅÆ12„Éî„Éº„Çπ„ÅÆ„ÅÑ„Åö„Çå„Åã„Å≤„Å®„Å§„Å®„Åä„Å™„Åò„ÇÄ„Åç„Å®„Åó„Åæ„Åô„ÄÇ'
      },
      'orientation': -2.094402963852356,
      'tiles': [
        [2, -2, 1, 2, 0, 0, 1],
        [1, -2, 0, 2, 1, 0, 2],
        [1, -3, 1, 2, 0, 0, 2],
        [0, -2, 0, 2, 1, 0, 2],
        [0, -3, 1, 2, 0, 0, 2],
        [0, -3, 0, 2, 1, 0, 2],
        [-1, -4, 1, 2, 0, 0, 2],
        [-1, -4, 0, 2, 1, 0, 2],
        [3, -3, 1, 0, 1, 0, 1],
        [2, -4, 1, 1, 1, 0, 1],
        [1, -5, 1, 2, 0, 0, 1],
        [0, -6, 1, 0, 0, 0, 1],
        [-1, -7, 1, 1, 0, 0, 1],
        [4, -2, 1, 2, 1, 0, 1],
        [4, -3, 0, 2, 1, 0, 1],
        [3, -4, 0, 1, 1, 0, 1],
        [2, -5, 0, 0, 1, 0, 1],
        [1, -6, 0, 2, 0, 0, 1],
        [0, -7, 0, 1, 0, 0, 1],
        [-1, -8, 0, 0, 0, 0, 1],
        [1, -2, 1, 2, 0, 0, 2],
        [-1, -3, 0, 2, 1, 0, 2],
        [0, -4, 1, 2, 0, 0, 2],
        [-2, -4, 0, 2, 1, 0, 1]
      ]
    }));
    ///
    count--;
    localStorage.setItem(APP.name + '__MIN', count);
    if (window.matchMedia && window.matchMedia('(max-device-width: 640px)').matches) {
      localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
        'meta': {
          'id': '',
          'base': '',
          'origin': '',
          artist: '_',
          'title': '„Åä„Å™„Åò„ÇÄ„Åç„Å´„Å°„Åå„ÅÜ„ÇÇ„Çà„ÅÜ„Åß„Å™„Çâ„Åπ„Çà„ÅÜ',
          'note': 'Ôºñ„Åó„ÇÖ„Çã„ÅÑ„ÅÆ„Åä„Åç„Åã„Åü„Çí„Åú„Çì„Å∂„Åü„ÇÅ„Åó„Å¶„Åø„Çà„ÅÜ!'
        }, "orientation":2.0919229374524506,
        "tiles":[[0,-3,1,1,1,0,0],[0,-1,1,1,0,0,0]]
      }));
    } else {
      localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
        'meta': {
          'id': '',
          'base': '',
          'origin': '',
          artist: '_',
          'title': '„Åä„Å™„Åò„ÇÄ„Åç„Å´„Å°„Åå„ÅÜ„ÇÇ„Çà„ÅÜ„Åß„Å™„Çâ„Åπ„Çà„ÅÜ',
          'note': 'Ôºñ„Åó„ÇÖ„Çã„ÅÑ„ÅÆ„Åä„Åç„Åã„Åü„Çí„Åú„Çì„Å∂„Åü„ÇÅ„Åó„Å¶„Åø„Çà„ÅÜ!'
        }, "orientation":2.0919229374524506,
        "tiles":[[0,-8,1,1,1,0,0],[0,-1,1,1,0,0,0]]
      }));
    }
  }

  function Unwrap(jsonStr) {
    if (!jsonStr) {
      return;
    }
    let json = JSON.parse(jsonStr);
    json.tiles.map(t => {
      if (t[6] > 1) {
        t[6] = 0;
      }
    });
    return JSON.stringify(json);
  }

  function Unlock(jsonStr) {
    if (!jsonStr) {
      return;
    }
    let json = JSON.parse(jsonStr);
    json.tiles.map(t => {
      t[6] = 0;
    });
    return JSON.stringify(json);
  }

  function moveMode() {
    document.body.classList.add('move');
    t3puzzle.setAttribute('mode', 'readonly');
    HISTORY.status = 'move';
  }

  function historyback() {
    if (HISTORY.back) {
      t3puzzle.setAttribute('loaddata', HISTORY.back);
    }
  }
  function clearall() {
    if (window.matchMedia && window.matchMedia('(max-device-width: 640px)').matches) {
      t3puzzle.setAttribute('loaddata', JSON.stringify({
        'meta': {
          'id': '',
          'base': '',
          'origin': '',
          artist: '_',
          'title': '„Åä„Å™„Åò„ÇÄ„Åç„Å´„Å°„Åå„ÅÜ„ÇÇ„Çà„ÅÜ„Åß„Å™„Çâ„Åπ„Çà„ÅÜ',
          'note': 'Ôºñ„Åó„ÇÖ„Çã„ÅÑ„ÅÆ„Åä„Åç„Åã„Åü„Çí„Åú„Çì„Å∂„Åü„ÇÅ„Åó„Å¶„Åø„Çà„ÅÜ!'
        }, "orientation":2.0919229374524506,
        "tiles":[[0,-3,1,1,1,0,0],[0,-1,1,1,0,0,0]]
      }));
    } else {
      t3puzzle.setAttribute('loaddata', JSON.stringify({
        'meta': {
          'id': '',
          'base': '',
          'origin': '',
          artist: '_',
          'title': '„Åä„Å™„Åò„ÇÄ„Åç„Å´„Å°„Åå„ÅÜ„ÇÇ„Çà„ÅÜ„Åß„Å™„Çâ„Åπ„Çà„ÅÜ',
          'note': 'Ôºñ„Åó„ÇÖ„Çã„ÅÑ„ÅÆ„Åä„Åç„Åã„Åü„Çí„Åú„Çì„Å∂„Åü„ÇÅ„Åó„Å¶„Åø„Çà„ÅÜ!'
        }, "orientation":2.0919229374524506,
        "tiles":[[0,-8,1,1,1,0,0],[0,-1,1,1,0,0,0]]
      }));
    }
  }
  function processData(value) {
    localStorage.setItem('DEBUG', JSON.stringify(
      value.detail.debug));
    let str = JSON.stringify(value.detail.value);
    HISTORY.back =
      localStorage.getItem(APP.name + '__DATA__LASTMODIFIED');
    localStorage.setItem(APP.name + '__DATA__LASTMODIFIED', str);
    HISTORY.status = 'change';
  }

  function dialogopen(action, modal, t3work, form, OBJ) {
    let submit = form.querySelector('input[type=submit]');
    let age = form.querySelector('input[name=age]');
    let filename = form.querySelector('input[name=filename]');
    let artist = form.querySelector('input[name=artist]');
    let title = form.querySelector('input[name=title]');
    let data = form.querySelector('input[name=data]');
    let note = form.querySelector('textarea[name=note]');
    let jsonStr = '';
    if (action === 'load') {
      load__history.style.display = 'inline-block';
      let {
        str,
        i
      } = loadData(modal);
      jsonStr = str;
      setStrToForm(form, jsonStr, i);
    } else if (action === 'download') {
      load__history.style.display = 'none';
      goto(t3work, form, OBJ.jsonStr, null);
    } else {
      //  
      dialog__src.style.display = 'block';
      dialog__img.style.display = 'none';
      //
      jsonStr = localStorage.getItem(APP.name +
        '__DATA__LASTMODIFIED');
      jsonStr = Unwrap(jsonStr);
      setmeta();
      markArtist();
      let artistStr = localStorage.getItem(APP.type + '__INFO--ARTIST');
      if (artistStr) {
        artist.value = artistStr;
      }
      let ageStr = localStorage.getItem(APP.type + '__INFO--AGE');
      if (ageStr) {
        age.value = ageStr;
      }
      data.value = jsonStr;
      title.value = UPLOAD.title;
      if (!title.value) {
        let placeholder = UPLOAD.placeholder;
        if (placeholder) {
          title.placeholder = '„Å†„ÅÑ„ÇÅ„ÅÑ(„Çå„ÅÑ)Ôºö' + placeholder;
        }
      }
      note.value = UPLOAD.note;
      jsonStr = Unlock(jsonStr);
    }
    if (jsonStr) {
      t3work.setAttribute('loaddata', jsonStr);
    }
    if (!OBJ.submitMessage) {
      OBJ.submitMessage = submit.value;
      OBJ.submitEvent = form.getAttribute('onsubmit');
    } else {
      submit.value = OBJ.submitMessage;
      form.setAttribute('onsubmit', OBJ.submitEvent);
      submit.removeAttribute('disabled');
    }
    modal.setAttribute('open', '');
  }

  function loadData(modal) {
    let {
      min,
      max
    } = getCountFromLocal();
    if (min === null) {
      return '';
    }
    let initpointer = max;
    if (LOAD.pointer !== null) {
      initpointer = LOAD.pointer;
    }
    let {
      str,
      i
    } = loadDataFromLocal(initpointer, false);
    LOAD.data = str;
    return {
      str,
      i
    };
  }

  function loadDataToMain(modal, form) {
    t3puzzle.setAttribute('loaddata', LOAD.data);
    UPLOAD.placeholder = load__title.value;
    console.log(LOAD.data);
    modal.setAttribute('close', '');
  }

  function setStrToForm(form, str, idx) {
    putmeta(str);
    setmeta();
    let title = form.querySelector('input[name=title]');
    let note = form.querySelector('textarea[name=note]');
    title.value = '';
    note.value = '';
    if (str) {
      let json = JSON.parse(str);
      if (json.meta.title) {
        title.value = json.meta.title;
      }
      if (json.meta.note) {
        note.value = json.meta.note;
      }
      if (idx !== null) {
        let {
          min,
          max
        } = getCountFromLocal();
        let base = max - min + 1;
        let now = idx - min + 1;
        LOAD.pointer = idx;
        load__number.textContent = (now) + '/' + (base);
      }
    }
  }

  function backward(item, form) {
    let idx = LOAD.pointer;
    let {
      str,
      i
    } = loadDataFromLocal(idx - 1, false);
    goto(item, form, str, i);
  }

  function forward(item, form) {
    let idx = LOAD.pointer;
    let {
      str,
      i
    } = loadDataFromLocal(idx + 1, true);
    goto(item, form, str, i);
  }

  function gohead(item, form) {
    let {
      min,
      max
    } = getCountFromLocal();
    let {
      str,
      i
    } = loadDataFromLocal(min, false);
    goto(item, form, str, i);
  }

  function goend(item, form) {
    let {
      min,
      max
    } = getCountFromLocal();
    let {
      str,
      i
    } = loadDataFromLocal(max, true);
    goto(item, form, str, i);
  }

  function goto(item, form, str, i) {
    if (str) {
      setStrToForm(form, str, i);
      LOAD.data = str;
      item.setAttribute('loaddata', str);
    }
  }

  function loadDataFromLocal(idx, direct) {
    let {
      min,
      max
    } = getCountFromLocal();
    let i = idx;
    let str = '';
    while (min !== null && min <= i && i <= max) {
      str = localStorage.getItem(
        APP.name + '__DATA__' + i);
      if (str) {
        LOAD.pointer = i;
        break;
      }
      if (direct) {
        i++;
      } else {
        i--;
      }
    }
    if (!str) {
      if (direct) {
        LOAD.pointer = max;
      } else {
        LOAD.pointer = min;
      }
    }
    return {
      str,
      i
    };
  }

  function getCountFromLocal() {
    let maxStr = localStorage.getItem(
      APP.name + '__MAX');
    let minStr = localStorage.getItem(
      APP.name + '__MIN');
    let min = null;
    let max = -1;
    if (minStr) {
      min = parseInt(minStr, 10);
    }
    if (maxStr) {
      max = parseInt(maxStr, 10);
    }
    return {
      min,
      max
    };
  }

  function addDataToLocal(form) {
    let data = form.querySelector(
      'input[name=data]').value;
    if (!data) {
      return;
    }
    let title = form.querySelector(
      'input[name=title]').value;
    let note = form.querySelector(
      'textarea[name=note]').value;
    // count up
    let {
      min,
      max
    } = getCountFromLocal();
    let count = max + 1;
    let json = JSON.parse(data);
    if (!('meta' in json)) {
      json.meta = {};
    }
    json.meta.title = title;
    json.meta.note = note;
    localStorage.setItem(
      APP.name + '__DATA__' +
      count, JSON.stringify(json));
    localStorage.setItem(
      APP.name + '__MAX', count);
  }

  function submitImage(src, form, OBJ) {
    let submit = form.querySelector('input[type=submit]');
    let age = form.querySelector('input[name=age]');
    let filename = form.querySelector('input[name=filename]');
    let artist = form.querySelector('input[name=artist]');
    let content = form.querySelector('input[name=content]');
    let dataStr = form.querySelector('input[name=data]').value;
    submit.disabled = 'disable';
    if (submit.value==='„Åª„Åû„Çì„Åô„Çã') {
      submit.value = '„Åª„Åû„Çì„Å°„ÇÖ„ÅÜ';
    } else {
      submit.value = '„Åä„ÅÜ„Åº„Å°„ÇÖ„ÅÜ';
    }
    addDataToLocal(form);
    localStorage.setItem(APP.type + '__INFO--AGE', age.value);
    saveImage(src, dataStr, OBJ, (value) => {
      // image
      dialog__src.style.display = 'none';
      dialog__img.style.display = 'block';
      dialog__img.src = 'data:image/png;base64,'+value;
      //
      filename.value = 'server_to_be_named.png';
      content.value = value;
      try {
        fetch_upload(form, OBJ,
          (json) => {
            submit.removeAttribute('disabled');
            if (false) {
              submit.value = '„ÉÑ„Ç§„Éº„Éà';
              let title = UPLOAD.title;
              let note = UPLOAD.note;
              let hash = '#FMSÁâπÂà•Ë¨õÁæ© #T3„Éë„Ç∫„É´';
              let url = 'https://drive.google.com/file/d/' + json.meta.image + '/view';
              let array = [title, note, hash, url];
              let tweet = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(array.join('\n'));
              form.setAttribute('onsubmit', `document.querySelector("#"+this.id+"__modal").setAttribute("close","");window.open("${tweet}");return false;`);
            } else {
              submit.value = '„Å®„Åò„Çã';
              form.setAttribute('onsubmit', 'document.querySelector("#"+this.id+"__modal").setAttribute("close","");return false;');
            }
            UPLOAD.title = '';
            UPLOAD.note = '';
            let data = JSON.parse(dataStr);
            data.meta = json.meta;
            history.replaceState('', '', '#!load=' + data.meta.id);
            let str = JSON.stringify(data);
            putmeta(str);
            localStorage.setItem(APP.name + '__DATA__LASTMODIFIED', str);
          }, (e) => {
            console.log(e);
            submit.value = 'üò®';
          }
        );
      } catch (e) {
        submit.value = 'üò®';
        console.log(e);
      }
    }, () => {
      submit.value = 'ü§î';
    })
  }

  function fetch_initdata() {
    if (/#!history=(\d+)/.test(location.href)) {
      let val = parseInt(RegExp.$1, 10);
      let minStr = localStorage.getItem(APP.name + '__MIN');
      if (minStr) {
        let min = parseInt(minStr, 10);
        let num = val + min - 1;
        let jstr = localStorage.getItem(APP.name + '__DATA__' + num);
        if (jstr) {
          dialogopen('download', load__form__modal, load__t3work, load__form, {
            jsonStr: jstr
          });
        }
      }
    } else if (/#!load=([^\?#]+)/.test(location.href)) {
      let id = RegExp.$1;
      let url = UPLOAD.url + '?id=' + encodeURIComponent(id);
      console.log(url);
      fetch(url, {
          method: 'GET',
          mode: 'cors',
          redirect: 'follow',
        })
        .then(r => r.text())
        .then(jstr => {
          dialogopen('download', load__form__modal, load__t3work, load__form, {
            jsonStr: jstr
          });
        });
    }
  }

  function fetch_upload(form, OBJ, successCallback, errorCallback) {
    const body = new FormData(form);
    fetch(OBJ.url, {
        method: 'POST',
        body: body,
        mode: 'cors',
        redirect: 'follow',
      })
      .then(r => r.json())
      .then(j => {
        if (successCallback) {
          successCallback(j);
        }
      }).catch(e => {
        if (errorCallback) {
          errorCallback(e);
        }
      });
  }

  function saveImage(src, dataStr, OBJ, successCallback, errorCallback) {
    (async () => {
      try {
        domtoimage.toPng(src).then(dataurl=>{
          let txt = (dataurl.split(',')[1]);
          let buf = buffer.Buffer.from(txt, 'base64');
          let json = JSON.parse(dataStr);
          delete json.meta;
          let metadata = {
            "tEXt": {
              "meta": JSON.stringify(json)
            }
          };
          let bufwithmeta = writeMetadata(buf, metadata);
          let b64 = bufwithmeta.toString('base64');
          successCallback(b64);
        });
                                   
      } catch (e) {
        console.log('e::' + e);
        errorCallback();
      }
    })();
  }

  function markArtist() {
    let artist = localStorage.getItem(APP.type + '__INFO--ARTIST');
    if (!artist) {
      localStorage.setItem(APP.type + '__INFO--ARTIST', Math.random().toString(32).substring(2));
    }
  }

  function rotate(_item) {
    let item = _item ? _item : t3puzzle;
    if (!_item) {
      if (HISTORY.status !== 'rotate') {
        item.setAttribute('fit', '');
      }
    }
    item.setAttribute('rotate', Math.PI / 6);
    HISTORY.status = 'rotate';
  }

  function zoom(_item) {
    let item = _item ? _item : t3puzzle;
    item.setAttribute('zoom', 0.9);
  }

  function bodyMovePrevent() {
    document.addEventListener('touchmove', e => e.preventDefault(), {
      passive: false
    });
    document.addEventListener('mousewheel', e => e.preventDefault(), {
      passive: false
    });
  }
</script>
<script src="https://www.t3puzzle.com/b/tapspace.min.js"></script>
<script src="https://www.t3puzzle.com/b/dom-to-image.min.js"></script>
<script src="https://www.t3puzzle.com/b/buttonText.js"></script>
<script src="https://www.t3puzzle.com/b/palleteText.js"></script>
<script src="https://www.t3puzzle.com/b/dialog-modal.js"></script>
<script src="https://www.t3puzzle.com/b/switch-text.js"></script>
  
<script src="./t3.js"></script>
<noscript><iframe width="600" height="1000" src="./support.html"></iframe></noscript>
</body>
</html>
