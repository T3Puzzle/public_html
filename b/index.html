
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-127386967-1"></script>
  <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-127386967-1');
  </script>
  <!-- end of ga --->
<script src="jscheck.js"></script>
<style>body {
  background:rgb(200,200,200);
  user-select: none;
  touch-action: none;
  -webkit-user-select: none;
}
body.move {
  background:rgb(175, 175, 175);
}
div.menu {
  position: absolute;
  top: 0px;
  padding-left: 1em;
  z-index: 5;
}
</style>
</head>
<body>

<script src="https://www.t3puzzle.com/b/buffer.js"></script>
<script src="https://www.t3puzzle.com/b/writeMetadata.js"></script>
<script>
  let APP = {
    name: 't3p',
    type: 'gridpuzzle'
  };
  APP.restored = localStorage.getItem(APP.name + '__DATA__LASTMODIFIED');
</script>
<div class="menu">
  
  <button-text text="🔙" size="40px" onclick="historyback();">
  </button-text>
  <button-text text="✗" size="40px" onclick="clearall();">
  </button-text>
  <switch-text onchange="t3puzzle.setAttribute('color',this.value)" value="blue" size="40px">
    <datalist>
      <option value="blue"></option>
      <option value="green"></option>
      <option value="pink"></option>
      <option value="mint"></option>
    </datalist>
  </switch-text>
  <button-text text="➰" onclick="t3puzzle.setAttribute('flipall','');" size="40px">
  </button-text>

  <button-text text="⌖" onclick="t3puzzle.setAttribute('fit','');" size="40px">
  </button-text>
 <div class="ui__pc" style="display:inline-block;">
  <button-text text="🔍" onclick="zoom();" size="20px">
  </button-text>
  <button-text text="⤿" onclick="rotate();" size="40px">
  </button-text>
  </div>

  <button-text text="↑⎵" onclick="dialogopen(
                                  'upload',
                                  dialog__form__modal,
                                  dialog__t3work, 
                                  dialog__form,
                                  UPLOAD)" size="40px">
  </button-text>
  <button-text text="📖" onclick="dialogopen(
                                  'load',
                                  load__form__modal,
                                  load__t3work, 
                                  load__form,
                                  LOAD)" size="40px">
  </button-text>
  <button-text text="？" onclick="dialog__help__modal.setAttribute('open','');" size="40px">
  </button-text>
</div>
<grid-puzzle style="margin-left:0px;" id="t3puzzle" mode="hand" onChange="processData(this.value)">
  <datalist>
    <grid-data>{
      "orientation":2.0919229374524506,"tiles":[[0,-3,1,1,1,0,0],[0,-1,1,1,0,0,0]]
      }
    </grid-data>
  </datalist>
</grid-puzzle>
<script>document.currentScript.insertAdjacentHTML('beforebegin',`
<dialog-modal id="dialog__help__modal">
  <template>
    <div style="margin-left:0px;width:320px;height:320px;">
       <b> T3コンテスト実施中！</b><br/>
       アプリで作った作品を応募しよう！<br/>
      応募方法は<a target="_blank" href="https://www.t3puzzle.com/contest">コンテストページへ</a><br/>
      <br/>
      <b>うまく応募できない時は…</b><br/>
      1) 画面キャプチャをとり、画像を<a target="_blank" href="https://www.t3puzzle.com/r/u/${location.search?'?id='+location.search.replace(/^\?/,''):''}">アップロードてください</a>
      <br/>
      2) ChromeやGoogleアプリで開く<br/><br/>
      参考:<a target="_blank" href="https://twitter.com/i/events/1471748985274593284">アプリの使い方</a><br/>
    </div>
  </template>
  </dialog-modal>
`);
</script>
<dialog-modal id="dialog__form__modal">
  <template>
    <div id="dialog__src" style="margin-left:0px;width:320px;height:320px; background: rgb(200, 200, 200);"></div>
    <grid-puzzle style="margin-left:0px;" id="dialog__t3work" width="320px" height="320px" mode="readonly" for="dialog__src">
      <datalist>
        <grid-data>
        </grid-data>
      </datalist>
    </grid-puzzle> 
    <img id="dialog__img" style="display:none;" width="320px" height="320px">
    <div style="width:100%;height:90%;margin: 3px;text-align: center;">
      <div class="ui__pc">
        <button-text text="⤿" onclick="rotate(dialog__t3work);" size="20px">
        </button-text>

        <button-text text="🔍" onclick="zoom(dialog__t3work);" size="20px">
        </button-text>

        <button-text text="⌖" onclick="dialog__t3work.setAttribute('fit','');" size="20px">
        </button-text>
      </div>
      <form id="dialog__form" action="#" style="text-align:left;" onsubmit="submitImage(dialog__src,dialog__form, UPLOAD);return false;">
        <input name="artist" type="hidden">
        <input name="data" type="hidden">
        <input name="filename" type="hidden">
        <input name="type" value="image/png" type="hidden">
        <input name="content" type="hidden">
        <input id="dialog__meta" name="meta" type="hidden">
        <label for="dialog__age">ねんれい:</label>
        <input required id="dialog__age" name="age" value="" type="number" min="0" max="150" style="width:35px;">
        <div style="display:inline-block;margin-top:10px;border-width:1px;">
          <input class="submit" type="submit" value="ほぞんする" style="background:#4676FF;-webkit-appearance: none;color:white;border-radius: 5px;border-width:0px;font-size:110%;">
        </div>
        <br /><input required placeholder="だいめい" name="title" type="text" style="width:305px;margin-top:3px;border-width:1px;" onchange="UPLOAD.title = this.value;">
        <div class="classunique" style="display:none;">
          学籍番号: <input type="text" name="unique" pattern="^[a-zA-Z0-9]*$" value="" onchange="updateEmailByUnique(this.form)">
        </div>
        <div class="classselect">
          <select name="grade" onchange="updateEmailBySelect(this.form)">
            <option value="1">1年</option>
            <option value="2">2年</option>
            <option value="" selected>??年</option>
            <option value="3">3年</option>
            <option value="4">4年</option>
            <option value="5">5年</option>
            <option value="6">6年</option>
          </select>
          <select name="group" onchange="updateEmailBySelect(this.form)">
            <option value="1">1組</option>
            <option value="2">2組</option>
            <option value="" selected>??組</option>
            <option value="3">3組</option>
            <option value="4">4組</option>
            <option value="5">5組</option>
            <option value="6">6組</option>
            <option value="a">A組</option>
            <option value="b">B組</option>
            <option value="c">C組</option>
            <option value="d">D組</option>
            <option value="e">E組</option>
            <option value="f">F組</option>
          </select>
          <select name="index" onchange="updateEmailBySelect(this.form)">
            <option value="-1">先生1</option>
            <option value="-2">先生2</option>
            <option value="-3">そのほか</option>
            <option value="1">1番</option>
            <option value="2">2番</option>
            <option value="3">3番</option>
            <option value="4">4番</option>
            <option value="5">5番</option>
            <option value="6">6番</option>
            <option value="7">7番</option>
            <option value="8">8番</option>
            <option value="9">9番</option>
            <option value="10">10番</option>
            <option value="11">11番</option>
            <option value="12">12番</option>
            <option value="13">13番</option>
            <option value="14">14番</option>
            <option value="15">15番</option>
            <option value="" selected>??番</option>
            <option value="16">16番</option>
            <option value="17">17番</option>
            <option value="18">18番</option>
            <option value="19">19番</option>
            <option value="20">20番</option>
            <option value="21">21番</option>
            <option value="22">22番</option>
            <option value="23">23番</option>
            <option value="24">24番</option>
            <option value="25">25番</option>
            <option value="26">26番</option>
            <option value="27">27番</option>
            <option value="28">28番</option>
            <option value="29">29番</option>
            <option value="30">30番</option>
            <option value="31">31番</option>
            <option value="32">32番</option>
            <option value="33">33番</option>
            <option value="34">34番</option>
            <option value="35">35番</option>
            <option value="36">36番</option>
            <option value="37">37番</option>
            <option value="38">38番</option>
            <option value="39">39番</option>
            <option value="40">40番</option>
            <option value="41">41番</option>
            <option value="42">42番</option>
            <option value="43">43番</option>
            <option value="44">44番</option>
            <option value="45">45番</option>
            <option value="46">46番</option>
            <option value="47">47番</option>
            <option value="48">48番</option>
            <option value="49">49番</option>
            <option value="50">50番</option>
          </select>    
        </div>
        <div class="email">
        <input placeholder="コンテストおうぼ→メールアドレス入力" name="email" type="email" style="width:305px;margin-top:3px;border-width:1px;" onchange="if(!/^[a-zA-Z0-9\.\+-@_]+$/.test(this.value)){this.value='';}this.form.querySelector('input.submit').value=(this.value.trim())?'おうぼする':'ほぞんする';">
        </div>
          <textarea placeholder="くふうしたこと　&#010;保存した作品および記入内容は公開させていただくことがあります" name="note" rows="3" onchange="UPLOAD.note = this.value;" style="width:305px;margin-top:3px;display:block;font-size:90%;border-width:1px;"></textarea>
      </form>
  </template>
</dialog-modal>

<dialog-modal id="load__form__modal">
  <template>
    <div id="load__src" style="width:320px;height:320px; background: rgb(200, 200, 200);"></div>
    <grid-puzzle style="margin-left:0px;" id="load__t3work" width="320px" height="320px" mode="readonly" for="load__src">
      <datalist>
        <grid-data>
        </grid-data>
      </datalist>
    </grid-puzzle>
    <div style="width:100%;height:90%;margin: 0px;text-align: center;">

    </div>
    <form id="load__form" action="#" style="text-align:left;" onsubmit="loadDataToMain(load__form__modal);return false;">
      <input name="artist" type="hidden">
      <input name="data" type="hidden">
      <input name="filename" type="hidden">
      <input name="type" value="image/png" type="hidden">
      <input id="load_meta" name="meta" type="hidden">
      <input name="content" type="hidden">
      <input id="load__age" name="age" type="hidden" min="0" max="150" style="width:35px;">
      <div style="display:inline-block;border-width:1px;">
        <div id="load__history" style="display:inline-block;">
          <button-text text="«" onclick="gohead(load__t3work,load__form);" size="30px">
          </button-text>
          <button-text text="‹" onclick="backward(load__t3work,load__form);" size="30px">
          </button-text>
          <div id="load__number" style="display:inline-block;"></div>

          <button-text text="›" onclick="forward(load__t3work,load__form);" size="30px">
          </button-text>
          <button-text text="»" onclick="goend(load__t3work,load__form);" size="30px">
          </button-text>
        </div>
        <input type="submit" value="はじめる" style="background:#46cc76;-webkit-appearance: none;color:white;border-radius: 5px;border-width:0px;font-size:110%;display:inline-block;">
      </div>
      <br />
      <input readonly id="load__title" name="title" type="text" style="width:305px;margin-top:3px;border-width:1px;">
      <textarea readonly id="load__note" name="note" rows="4" style="width:305px;margin-top:3px;display:block;font-size:90%;border-width:1px;"></textarea>
    </form>
  </template>
</dialog-modal>

</div>
<script>
  let HISTORY = {
    status: '',
    back: ''
  };
  function updateEmailBySelect(form) {
    let search = location.search;
    if (!search) {
      return;
    }
    let qs = search.replace(/^\?/,'');
    if (!qs) {
      return;
    }
    if (! /^[a-z0-9]+$/.test(qs)) {
      return;
    }
    let grade = form.querySelector('select[name="grade"]').value;
    if (grade !== '') {
      let index = form.querySelector('select[name="index"]').value;
      if (index !== '') {
        let group = form.querySelector('select[name="group"]').value;
        if (group !== '') {
          let email = form.querySelector('input[name="email"]');
          email.value = 'info+'+[qs,grade,group,index].join('_')+'@tessellation.jp';
          email.onchange();
        }
      }
    }
  }
  function updateEmailByUnique(form) {
    let search = location.search;
    if (!search) {
      return;
    }
    let qs = search.replace(/^\?/,'');
    if (!qs) {
      return;
    }
    if (! /0x0x$/.test(qs)) {
      return;
    }
    let unique = form.querySelector('input[name="unique"]').value;
    if (unique !== '') {
      let email = form.querySelector('input[name="email"]');
      email.value = 'info+'+qs+'_'+unique+'@tessellation.jp';
      email.onchange();
    }
  }
  function putmeta(str) {
    if (!str) {
      return;
    }
    let json = JSON.parse(str);
    if (!('meta' in json)) {
      return;
    }
    localStorage.setItem(APP.name + '__meta__LASTLOADED', JSON.stringify(json.meta));
  }

  function setmeta() {
    let value = localStorage.getItem(APP.name + '__meta__LASTLOADED');
    if (value) {
      dialog__meta.value = value;
    }
  }

  function loadInitData() {
    let str = APP.restored;
    if (str) {
      t3puzzle.setAttribute('loaddata', str);
      setmeta();
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    loadInitData();
    bodyMovePrevent();
    if (('ontouchend' in document)) {
      Array.from(document.querySelectorAll('.ui__pc')).map(u => {
        u.style['display'] = 'none';
      });
    }
    loadPreset();
    /////
    fetch_initdata();
    ///////
  });
  let UPLOAD = {
    imageNode: null,
    lastImageNode: null,
    submitMessage: '',
    submitEvent: '',
    title: '',
    note: '',
    url: 'https://script.google.com/a/tessellation.jp/macros/s/AKfycbzNfVfpZuYhGT6XZ_0ElgV0ASYb2_Th1qOOjvBWUWssEPBGm3fM/exec'
  }
  let LOAD = {
    imageNode: null,
    lastImageNode: null,
    submitMessage: '',
    submitEvent: '',
    url: UPLOAD.url,
    pointer: null,
    preset: 0,
  }
  function preset (count,title,note,orientation,tiles) {
    localStorage.setItem(APP.name + '__MIN', count);
    localStorage.setItem(APP.name + '__DATA__' + count, JSON.stringify({
      'meta': {
        'id': 'preset' + count,
        'base': '',
        'origin': '',
        artist: '_',
        "title":title,"note":note
      },
      "orientation":orientation,"tiles":tiles
    }));
    ///
    count--;  
    return count;
  }
  function loadPreset() {
    let count = -1;
  
    /////
    count = preset(count,"ちょうちょ","とんでます",2.615523829573199,
     [[-1,-1,0,1,1,0,0],[-1,-2,1,1,0,0,0],[-1,-2,0,1,1,0,0],[-1,-3,1,2,1,1,0],[-2,-2,0,1,1,3,0],[-2,-3,0,2,0,1,0],[-3,-3,0,2,0,3,0],[-2,-4,1,2,1,1,0],[-3,-4,0,0,1,0,0],[0,-3,1,0,1,0,0],[-1,-3,0,2,1,1,0],[-1,-4,1,2,0,1,0],[-2,-4,0,2,1,1,0],[-1,-4,0,1,0,3,0],[0,-4,1,0,1,3,0],[0,-3,0,0,0,0,0],[-1,-5,1,2,0,3,0],[-2,-5,1,1,1,0,0],[-2,-5,0,1,0,0,0],[-3,-4,1,0,0,0,0],[1,-4,1,2,1,0,0],[1,-3,0,1,1,0,0],[-2,-2,1,2,0,0,0],[-2,-1,0,2,1,0,0],[-1,-1,1,0,1,0,0],[1,-3,1,0,1,0,0],[0,-2,0,2,1,1,0],[1,-2,1,0,1,2,0],[0,-1,0,1,1,2,0],[0,-2,1,2,1,1,0],[-2,-6,1,1,1,0,0],[-2,-6,0,0,1,0,0],[-1,-5,0,1,1,0,0],[-1,-6,1,2,1,0,0],[-4,-4,0,0,1,0,0],[-4,-4,1,1,1,0,0],[-4,-3,0,2,1,0,0],[-3,-3,1,0,1,0,0],[0,-5,1,0,1,0,0],[0,-4,0,2,0,0,0],[-3,-2,0,1,1,0,0],[-2,-3,1,0,0,3,0],[-3,-5,0,2,1,1,0],[-3,-5,1,2,1,1,0]
     ]    
    );    
    /////
    count = preset(count,"かぶとむし","いちばんつよいぞ",-2.6179995559649907,
     [[2,0,0,0,1,0,0],[2,0,1,1,1,0,0],[2,-1,1,2,1,0,0],[2,-1,0,1,1,0,0],[1,-1,0,0,1,0,0],[1,-1,1,2,1,0,0],[1,0,0,1,1,0,0],[2,1,0,1,0,0,0],[1,0,1,1,0,0,0],[1,-2,0,1,0,0,0],[2,-2,1,1,0,0,0],[1,-2,1,1,1,0,0],[2,1,1,2,1,0,0],[1,1,0,0,1,0,0],[1,1,1,0,0,0,0],[0,-3,0,2,1,2,0],[1,-3,1,0,1,0,0],[2,-3,1,2,0,0,0],[2,-2,0,2,1,0,0],[1,-3,0,0,0,0,0],[0,-4,1,1,1,2,0],[3,-2,1,0,1,2,0],[3,-2,0,1,1,2,0],[3,0,1,2,1,2,0],[3,1,0,1,1,2,0],[0,-1,0,0,1,2,0],[0,-1,1,1,1,2,0],[0,-2,0,2,1,2,0],[3,-1,1,0,1,2,0],[3,-1,0,0,0,2,0],[0,-3,1,2,0,2,0],[2,2,0,2,0,0,0]
     ]   
    );    
    /////
    count = preset(count,"かめ","うみがめといっしょにおよぎたい！",-2.620466617916703,
     [[0,-1,0,0,1,0,0],[0,-2,1,1,0,0,0],[-1,-2,0,1,0,0,0],[0,-3,1,2,1,0,0],[-1,-3,0,0,1,0,0],[-1,-3,1,1,1,0,0],[0,-2,0,1,1,0,0],[0,-1,1,1,1,0,0],[-1,-1,0,1,1,0,0],[-1,-2,1,2,1,0,0],[1,-1,1,2,1,0,0],[-2,-2,0,0,1,0,0],[0,-3,0,0,0,0,0],[-1,-4,1,2,0,0,0],[-2,-4,0,0,0,0,0],[1,-3,1,2,0,0,0],[1,-1,0,0,0,0,0],[-2,-3,1,2,0,0,0]]
    );    
    /////
    count = preset(count,"きんぎょ","ゆらゆらおよぐ",-1.573268493223623,
     [[0,-3,1,2,1,1,0],[0,-1,1,0,1,1,0],[0,-1,0,1,1,1,0],[0,-2,1,2,1,1,0],[-1,-3,1,0,0,0,0],[-1,-2,0,2,0,1,0],[-1,-2,1,2,0,1,0],[-1,-1,0,2,1,1,0],[0,0,0,2,1,1,0],[1,0,1,2,1,1,0],[-1,-4,1,2,1,1,0],[-1,-3,0,2,0,1,0],[-2,-3,0,1,0,1,0],[-2,-4,0,0,1,1,0],[-2,-4,1,1,1,1,0],[-2,-3,1,1,1,1,0],[-2,-2,0,2,1,1,0],[0,-2,0,1,1,1,0],[0,0,1,1,1,1,0],[1,1,1,2,0,1,0],[1,1,0,2,1,1,0],[0,1,0,1,1,1,0],[-2,-2,1,1,1,1,0],[-2,-1,0,0,1,1,0],[0,1,1,1,1,1,0],[2,1,1,2,1,1,0],[-1,-1,1,0,0,1,0],[0,2,0,2,0,1,0],[2,2,0,1,0,1,0],[1,2,0,2,0,1,0]
     ]   
    );    
    /////
    count = preset(count,"かも","とべるかも",2.0919218241956763,
     [[-2,-1,0,1,1,0,0],[-2,0,0,1,1,0,0],[-1,0,1,1,0,0,0],[-1,0,0,1,1,0,0],[0,-1,1,0,1,2,0],[1,-1,1,1,1,2,0],[0,-1,0,1,1,2,0],[-1,-1,1,2,1,0,0],[-1,1,0,0,1,0,0],[-1,1,1,2,1,0,0],[-1,-1,0,2,1,2,0],[-2,-1,1,1,0,0,0],[0,-2,1,1,0,1,0],[-1,-2,1,2,0,2,0],[-2,-2,0,0,0,2,0],[-2,-2,1,1,0,2,0],[-2,0,1,1,0,0,0],[-2,1,0,2,0,0,0],[0,-2,0,0,0,1,0]
     ]   
    );  
    /////
    count = preset(count,"せんしゅ","うんどうせんしゅ！",-1.5732684859738668,
     [[0,-1,0,0,1,1,0],[0,-2,1,0,1,1,0],[0,-2,0,1,1,0,0],[1,-2,1,0,1,0,0],[2,-2,1,0,1,0,0],[2,-1,0,0,1,0,0],[1,-2,0,0,0,0,0],[3,-2,1,0,1,2,0],[2,-2,0,0,0,2,0],[3,-1,1,2,1,2,0],[4,-2,1,0,1,2,0],[3,-2,0,0,0,2,0],[4,-2,0,0,0,2,0],[2,-1,1,0,0,0,0],[1,-1,0,0,1,0,0],[0,-3,1,1,0,1,0],[0,-3,0,0,0,1,0],[1,-3,1,0,1,1,0],[2,-3,1,2,0,1,0],[1,-3,0,0,0,1,0],[1,-1,1,2,1,0,0],[1,0,0,1,1,1,0],[5,-2,1,2,0,3,0],[5,-1,0,1,0,3,0],[3,0,0,2,0,2,0],[4,0,1,0,0,2,0],[1,0,1,1,0,1,0],[4,0,0,1,0,2,0],[4,-1,1,1,1,2,0],[4,-1,0,2,1,3,0],[3,-1,0,1,0,2,0]
     ]    
    );    
    /////
    count = preset(count,"バラ","あおいバラみつけた！(2021年秋投稿作品)",1.2004542128448064,
     [[0,0,0,0,0,0,0],[1,-1,1,2,1,0,0],[0,-1,0,0,1,0,0],[0,0,1,1,0,0,0],[0,1,0,2,1,0,0],[2,1,1,1,0,0,0],[2,1,0,1,1,0,0],[2,0,1,2,1,0,0],[-1,-1,0,0,0,0,0],[-1,-1,1,1,0,0,0],[-1,1,0,2,0,0,0],[-1,0,1,2,1,0,0],[0,1,1,2,0,0,0],[1,2,0,0,0,0,0],[1,2,1,0,1,0,0],[1,-1,0,0,1,0,0],[2,0,0,2,0,0,0],[2,-1,1,2,1,0,0],[3,0,1,2,1,0,0],[3,1,1,1,0,0,0],[3,1,0,1,1,0,0],[3,2,1,2,1,0,0],[3,3,1,0,1,0,0],[2,3,1,0,1,0,0],[3,3,0,1,1,0,0],[1,3,0,2,1,0,0],[-1,-2,1,0,1,0,0],[-1,-2,0,0,0,0,0],[0,-2,0,0,1,0,0],[1,-2,1,2,1,0,0],[-2,-2,0,0,0,0,0],[-2,-1,1,2,1,0,0],[-2,0,1,1,1,0,0],[-2,0,0,0,1,0,0],[-1,1,1,2,0,0,0],[-2,1,0,2,1,0,0],[-1,2,0,2,1,0,0],[0,2,1,0,1,0,0],[1,3,1,0,1,0,0],[0,3,0,2,1,0,0],[1,1,0,1,1,0,0],[1,0,0,2,0,0,0],[1,1,1,0,1,0,0],[1,0,1,1,0,0,0],[-1,0,0,1,1,0,0],[0,-1,1,0,1,0,0],[0,2,0,2,1,0,0],[2,2,1,1,1,0,0],[2,2,0,0,1,0,0],[0,-2,1,1,1,0,0],[-2,-1,0,1,1,0,0],[-1,2,1,0,1,0,0],[-2,2,0,2,1,0,0],[-2,1,1,1,1,0,0],[-3,0,0,1,0,0,0],[-3,1,0,2,1,0,0],[-3,-1,1,1,1,0,0],[2,4,0,2,1,0,0],[3,4,1,0,1,0,0],[3,4,0,0,0,0,0],[2,3,0,0,0,0,0],[4,3,1,1,0,0,0],[4,4,1,0,1,0,0],[4,4,0,1,1,0,0],[4,3,0,1,1,0,0],[4,2,1,2,1,0,0],[3,2,0,0,1,0,0],[2,4,1,0,1,0,0],[1,4,1,0,1,0,0],[0,4,0,2,1,0,0],[0,3,1,2,0,0,0],[-1,3,1,2,0,0,0],[-1,4,0,2,1,0,0],[1,5,0,2,1,0,0],[2,5,1,0,1,0,0],[2,5,0,0,0,0,0],[3,5,1,0,1,0,0],[3,5,0,1,1,0,0],[1,4,0,0,0,0,0],[-1,3,0,2,1,0,0],[0,4,1,0,1,0,0],[-2,3,0,2,1,0,0],[-2,2,1,1,1,0,0],[-2,-3,0,0,1,0,0],[-2,-3,1,0,0,0,0],[-3,-3,0,0,1,0,0],[-3,-2,0,1,0,0,0],[-3,-3,1,1,1,0,0],[-2,-2,1,1,0,0,0],[-3,-2,1,2,1,0,0],[-3,0,1,1,1,0,0],[-3,-1,0,0,1,0,0],[-1,-3,1,2,1,0,0],[-4,-2,1,2,1,2,0],[-5,-2,1,2,0,2,0],[-5,-2,0,0,1,2,0],[-5,-1,0,2,1,2,0],[-4,-1,1,0,1,2,0],[-6,-2,0,2,1,2,0],[-4,-1,0,2,0,2,0],[-6,-3,1,2,0,2,0],[-5,-3,1,0,0,2,0],[-4,-3,1,2,1,2,0],[-5,-3,0,0,1,2,0],[-4,-2,0,2,0,2,0],[-6,-3,0,0,0,2,0]
     ]
    );
    /////
    count = preset(count,"サルスベリのはな","ぴんくのはな！",1.2004542128448064,
     [[0,-4,0,2,1,3,0],[0,-5,1,1,1,3,0],[0,-5,0,0,1,3,0],[1,-5,1,2,1,3,0],[1,-4,0,1,1,3,0],[1,-4,1,0,1,3,0],[2,-3,0,2,1,1,0],[2,-4,1,2,0,1,0],[1,-3,0,1,0,1,0],[1,-3,1,1,1,1,0],[0,-4,1,0,0,1,0],[-1,-4,0,0,1,1,0],[-1,-5,0,2,0,1,0],[-1,-6,1,2,1,1,0],[0,-6,1,1,0,1,0],[1,-5,0,0,0,1,0],[2,-5,1,0,1,1,0],[2,-4,0,0,1,1,0],[-1,-6,0,2,1,1,0],[0,-3,0,1,1,1,0],[1,-6,1,1,1,1,0],[0,-6,0,1,1,1,0],[2,-3,1,2,1,1,0],[-1,-5,1,0,1,1,0],[2,-5,0,1,1,1,0],[3,-4,1,2,1,1,0],[3,-3,1,0,1,1,0],[2,-2,0,1,1,1,0],[1,-2,0,2,1,1,0],[0,-3,1,0,1,1,0],[-1,-4,1,1,1,1,0],[-2,-5,0,2,1,1,0],[-2,-6,0,0,1,1,0],[-1,-7,1,1,1,1,0],[0,-7,1,2,1,1,0],[1,-6,0,0,1,1,0],[1,-7,1,2,0,1,0],[0,-7,0,0,0,1,0],[3,-5,1,2,0,1,0],[3,-4,0,1,0,1,0],[3,-2,0,1,0,1,0],[3,-2,1,0,0,1,0],[1,-2,1,0,0,1,0],[0,-2,0,2,0,1,0],[-2,-4,0,2,0,1,0],[-2,-5,1,1,0,1,0],[-2,-7,0,0,0,1,0],[-2,-7,1,1,0,1,0]
     ]
    );
    /////
    count = preset(count,"おさる","かおのひょうじょうをかえてみよう！",2.0919237747911223,
     [[0,-3,1,1,0,0,0],[0,-2,0,1,0,0,0],[0,-2,1,1,0,0,0],[-1,-2,0,1,0,1,0],[-1,-3,0,1,0,1,0],[-1,-3,1,1,1,1,0],[1,-1,1,0,1,2,0],[0,-1,0,0,0,2,0],[1,-1,0,1,1,2,0],[1,-2,1,1,0,2,0],[1,-2,0,1,1,2,0],[1,-3,1,2,1,2,0],[0,-3,0,2,0,2,0],[-1,-1,0,2,1,2,0],[0,-1,1,0,1,2,0],[-1,-2,1,2,0,2,0],[-1,-4,1,0,0,2,0],[-1,-4,0,0,1,2,0],[0,-4,1,2,1,2,0],[-2,-2,0,2,1,2,0],[-2,-3,1,1,1,2,0],[-2,-3,0,1,0,2,0],[-2,-4,0,0,1,2,0],[-2,-4,1,1,1,2,0],[1,-3,0,0,1,2,0],[1,0,0,2,1,2,0],[1,0,1,0,1,2,0],[0,0,0,2,1,2,0],[1,-4,1,2,1,2,0],[0,-4,0,0,1,2,0]
     ]
    );
    /////
    count = preset(count,"くるま","どこにドライブいこう？",2.0919237747911223,
     [[0,-3,0,2,1,2,0],[1,0,1,0,1,2,0],[1,0,0,1,1,2,0],[1,-1,1,2,1,2,0],[0,-1,0,0,1,2,0],[0,-1,1,1,1,2,0],[0,0,0,2,1,2,0],[1,-1,0,1,1,1,0],[2,-1,0,1,1,1,0],[2,-1,1,1,0,1,0],[2,0,1,0,1,1,0],[2,0,0,1,1,1,0],[2,-2,1,2,1,1,0],[1,-3,1,0,1,2,0],[1,-3,0,1,1,2,0],[1,-4,1,2,1,2,0],[0,-4,0,0,1,2,0],[0,-4,1,1,1,2,0],[1,-2,1,1,0,1,0],[1,-2,0,1,1,1,0],[0,-3,1,1,0,1,0],[0,-2,0,1,1,1,0],[0,-2,1,1,0,1,0],[1,-4,0,1,1,1,0],[1,-5,1,2,1,1,0],[0,-5,0,1,1,1,0],[0,-5,1,1,0,1,0],[2,-3,1,2,0,0,0],[2,-2,0,2,1,0,0],[1,1,0,1,1,1,0],[1,1,1,2,1,1,0],[0,1,0,2,0,1,0],[0,0,1,1,0,1,0]
     ]
    );
    /////
    count = preset(count,"キューピーさん","かみのけが、たっています",2.0919237747911223,
     [[0,-8,1,1,1,0,0],[0,-8,0,0,1,0,0],[1,-8,1,1,1,0,0],[1,-7,0,1,0,0,0],[1,-7,1,1,1,0,0],[0,-7,0,0,1,0,0],[1,-6,0,1,0,0,0],[1,-6,1,1,1,0,0],[1,-5,0,1,0,0,0],[1,-5,1,1,1,0,0],[0,-6,1,1,1,0,0],[0,-6,0,0,1,0,0],[0,-7,1,0,0,1,0],[1,-8,0,0,0,1,0],[2,-7,0,2,0,1,0],[3,-4,1,1,1,2,0],[2,-4,1,1,1,2,0],[1,-4,0,2,1,0,0],[0,-4,0,2,1,1,0],[-1,-5,0,2,1,1,0],[-1,-6,1,2,0,1,0],[-2,-7,1,1,1,1,0],[-2,-7,0,1,0,1,0],[-2,-8,1,1,1,1,0],[-2,-8,0,0,1,1,0],[3,-4,0,2,0,2,0],[-2,-6,0,2,1,1,0],[-1,-7,0,1,0,1,0],[-1,-8,1,0,0,1,0],[-1,-8,0,0,1,1,0],[-1,-7,1,1,1,1,0],[-1,-6,0,1,0,1,0],[2,-3,0,0,1,2,0],[3,-3,1,0,0,2,0],[3,-3,0,0,1,2,0],[0,-5,0,0,1,0,0],[1,-4,1,0,1,1,0],[2,-4,0,1,0,2,0],[4,-4,0,1,0,2,0],[4,-4,1,1,1,2,0],[4,-5,1,1,1,2,0],[4,-5,0,0,1,2,0],[4,-3,0,1,0,2,0],[4,-3,1,0,0,2,0],[2,-3,1,0,0,2,0],[1,-3,0,2,0,2,0],[0,-5,1,0,1,1,0],[2,-7,1,2,0,1,0],[2,-6,0,1,0,1,0],[3,-6,1,1,0,2,0],[3,-5,0,2,0,2,0],[3,-5,1,1,0,2,0],[2,-5,1,0,0,1,0],[2,-5,0,1,0,1,0],[2,-6,1,2,0,1,0],[5,-5,1,0,0,2,0],[3,-6,0,2,0,1,0],[4,-6,1,0,1,2,0],[3,-7,1,2,1,1,0],[2,-8,1,0,1,1,0]
     ]
    );
    /////
    count = preset(count,"トマト","おいしそう！(2022年冬投稿作品)",2.0849594332185353,
     [[2,-4,1,2,0,1,0],[1,-4,0,2,1,1,0],[0,-6,1,2,1,1,0],[-2,-6,0,2,0,1,0],[-1,-5,0,1,1,1,0],[1,-5,1,2,0,1,0],[0,-5,0,1,0,1,0],[0,-4,0,2,1,1,0],[0,-5,1,0,1,1,0],[-1,-6,0,0,1,1,0],[0,-4,1,2,1,1,0],[-1,-4,0,2,0,1,0],[-1,-5,1,0,0,1,0],[-2,-5,0,1,1,1,0],[-2,-6,1,2,0,1,0],[-1,-6,1,1,0,1,0],[-2,-5,1,2,1,1,0],[-2,-4,0,0,1,1,0],[-1,-3,1,1,1,1,0],[-1,-3,0,0,1,1,0],[-1,-4,1,2,1,1,0],[0,-3,1,1,1,1,0],[1,-3,1,2,0,1,0],[2,-3,1,2,1,1,0],[1,-3,0,0,1,1,0],[1,-4,1,2,0,1,0],[2,-3,0,2,0,1,0],[2,-2,0,1,1,1,0],[2,-2,1,1,0,1,0],[1,-2,0,0,0,1,0],[1,-2,1,1,0,1,0],[0,-2,1,2,1,1,0],[-1,-2,0,0,1,1,0],[-1,-2,1,0,0,1,0],[-2,-3,1,1,0,1,0],[-2,-3,0,2,1,1,0],[-2,-4,1,0,1,1,0],[-2,-2,0,1,1,1,0],[-1,-1,0,2,1,1,0],[0,-1,1,2,0,1,0],[0,0,0,2,1,1,0],[1,0,1,1,1,1,0],[2,1,0,1,1,1,0],[2,0,1,1,0,1,0],[3,1,0,1,0,1,0],[4,1,1,0,0,1,0],[4,0,1,1,0,2,0],[4,0,0,0,1,2,0],[4,-1,1,2,0,2,0],[4,-1,0,1,0,2,0],[4,-2,0,1,1,2,0],[4,-3,1,2,0,1,0],[3,-4,0,2,0,1,0],[2,-5,0,2,0,1,0],[2,-6,1,2,1,1,0],[1,-7,1,2,0,1,0],[0,-7,1,2,0,1,0],[-1,-7,0,2,1,1,0],[-2,-7,0,1,1,1,0],[-3,-7,0,2,1,1,0],[-3,-7,1,2,0,1,0],[-3,-6,1,1,1,1,0],[-3,-5,1,0,0,1,0],[-3,-4,1,2,0,1,0],[-3,-3,0,1,0,1,0],[-3,-3,1,2,0,1,0],[-3,-2,0,0,1,1,0],[-2,-1,0,0,0,1,0],[-1,0,0,2,1,1,0],[0,0,1,0,0,1,0],[0,1,0,2,0,1,0],[-1,-1,1,2,0,1,0],[-2,-2,1,2,1,1,0],[-3,-4,0,0,1,1,0],[-3,-5,0,2,1,1,0],[-3,-6,0,2,1,1,0],[-2,-7,1,2,1,1,0],[-1,-7,1,2,1,1,0],[0,-6,0,1,1,1,0],[1,-6,1,2,1,1,0],[1,-5,0,2,0,1,0],[3,-2,0,2,1,2,0],[3,-1,0,1,0,2,0],[2,-1,1,1,0,2,0],[2,-1,0,2,0,1,0],[3,-1,1,2,0,2,0],[3,0,1,0,0,2,0],[2,0,0,0,1,2,0],[3,-2,1,1,1,2,0],[4,-2,1,1,0,2,0],[3,-3,0,2,1,1,0],[3,-4,1,2,0,1,0],[2,-4,0,2,1,1,0],[2,-5,1,1,1,1,0],[4,-3,0,1,0,1,0],[4,-4,1,2,0,1,0],[3,-5,1,2,0,1,0],[1,-6,0,2,0,1,0],[0,-7,0,0,0,1,0],[1,-1,0,0,0,1,0],[1,0,0,1,0,1,0],[0,-1,0,2,0,1,0],[1,-1,1,1,0,1,0],[0,-3,0,2,1,1,0],[0,-2,0,0,1,1,0],[1,1,1,2,1,1,0],[1,1,0,0,1,1,0],[2,1,1,2,1,1,0],[3,1,1,2,1,1,0],[4,1,0,1,1,1,0],[3,-3,1,2,1,2,0],[5,0,1,2,0,2,0],[5,-2,1,2,0,2,0],[3,0,0,2,0,2,0]
     ]
    );
    /////
    count = preset(count,"ニジ","きれいなニジがみえたよ(2022年冬投稿作品)",2.0849594332185353,
     [[0,-8,0,2,0,0,0],[2,-7,1,2,1,0,0],[2,-5,1,1,0,0,0],[2,-4,0,1,1,0,0],[0,-8,1,2,1,3,0],[0,-7,0,2,0,3,0],[1,-7,1,2,1,3,0],[1,-6,0,1,1,3,0],[1,-6,1,1,0,3,0],[1,-5,0,1,1,3,0],[1,-5,1,1,0,3,0],[1,-4,0,1,1,3,0],[1,-4,1,0,1,3,0],[1,-8,1,2,1,0,0],[0,-3,1,0,1,0,0],[0,-3,0,0,0,0,0],[2,-3,1,0,1,0,0],[0,-9,0,2,0,2,0],[1,-8,0,2,0,2,0],[2,-7,0,2,0,2,0],[2,-8,1,2,1,2,0],[3,-7,1,2,1,2,0],[3,-6,0,1,1,2,0],[3,-6,1,1,0,2,0],[3,-5,0,1,1,2,0],[3,-4,0,1,1,2,0],[3,-3,0,1,1,2,0],[3,-2,0,1,1,2,0],[3,-2,1,0,1,2,0],[2,-2,1,0,1,2,0],[0,-2,0,0,0,2,0],[1,-2,1,0,1,2,0],[0,-10,1,2,1,2,0],[0,-2,1,0,1,2,0],[3,-8,1,2,1,1,0],[3,-7,0,2,0,1,0],[4,-7,1,2,1,1,0],[4,-6,0,1,1,1,0],[4,-5,0,1,1,1,0],[2,-9,1,2,1,1,0],[2,-8,0,2,0,1,0],[4,-6,1,1,0,1,0],[1,-9,0,2,0,1,0],[1,-10,1,2,1,1,0],[0,-11,1,2,1,1,0],[0,-10,0,2,0,1,0],[4,-5,1,1,0,1,0],[4,-4,0,1,1,1,0],[4,-4,1,1,0,1,0],[4,-3,0,1,1,1,0],[4,-3,1,1,0,1,0],[4,-2,0,1,1,1,0],[4,-2,1,1,0,1,0],[4,-1,0,1,1,1,0],[4,-1,1,0,1,1,0],[3,-1,0,0,0,1,0],[3,-1,1,0,1,1,0],[2,-1,0,0,0,1,0],[2,-1,1,0,1,1,0],[1,-1,0,0,0,1,0],[1,-1,1,0,1,1,0],[0,-1,0,0,0,1,0],[0,-1,1,0,1,1,0],[1,-9,1,2,1,2,0],[3,-5,1,1,0,2,0],[3,-4,1,1,0,2,0],[3,-3,1,1,0,2,0],[2,-2,0,0,0,2,0],[1,-2,0,0,0,2,0],[0,-9,1,2,1,0,0],[1,-7,0,2,0,0,0],[2,-6,0,1,1,0,0],[2,-6,1,1,0,0,0],[2,-5,0,1,1,0,0],[2,-4,1,1,0,0,0],[2,-3,0,1,1,0,0],[1,-3,0,0,0,0,0],[1,-3,1,0,1,0,0],[0,-4,0,0,0,3,0],[0,-4,1,0,1,3,0],[-2,-12,0,1,0,0,0],[-2,-12,1,2,0,0,0],[-2,-11,1,1,0,0,0],[-2,-10,0,1,0,0,0],[-3,-13,1,1,1,0,0],[-3,-12,0,1,0,0,0],[-3,-12,1,1,1,0,0],[-3,-11,0,1,0,0,0],[-3,-11,1,1,1,0,0],[-3,-10,0,1,0,0,0],[-3,-10,1,1,1,0,0],[-3,-9,0,2,1,0,0],[-1,-9,1,1,0,0,0],[-1,-8,0,1,1,0,0],[-2,-8,0,2,1,0,0],[-1,-8,1,0,1,0,0],[-1,-5,1,2,1,0,0],[-2,-5,0,0,1,0,0],[-3,-5,0,0,1,0,0],[-2,-5,1,0,0,0,0],[-3,-5,1,1,1,0,0],[-3,-4,0,1,0,0,0],[-3,-4,1,1,1,0,0],[-3,-3,0,1,0,0,0],[-3,-2,0,1,0,0,0],[-3,-3,1,1,1,0,0],[-3,-2,1,1,1,0,0],[-1,-4,0,1,1,0,0],[-1,-3,0,1,1,0,0],[-1,-2,0,1,1,0,0],[-1,-2,1,1,0,0,0],[-1,-3,1,1,0,0,0],[-1,-1,0,1,1,0,0],[-1,-1,1,1,0,0,0],[-1,0,0,1,1,0,0],[-1,0,1,0,1,0,0],[-2,0,0,2,1,0,0],[-3,-1,0,2,1,0,0],[-2,-1,0,0,0,0,0],[-2,-2,1,2,0,0,0],[-2,-2,0,1,0,0,0],[-2,-3,1,1,0,0,0],[-2,-3,0,2,0,0,0],[-2,-4,1,2,0,0,0],[-2,-4,0,1,0,0,0],[-1,-10,1,1,0,0,0],[-1,-9,0,1,1,0,0],[-1,-10,0,1,1,0,0],[-1,-11,1,1,0,0,0],[-1,-11,0,1,1,0,0],[-1,-12,1,1,0,0,0],[-3,-13,0,0,1,0,0],[-2,-13,1,0,0,0,0],[-2,-13,0,0,1,0,0],[-1,-13,1,2,1,0,0],[-1,-12,0,1,1,0,0],[-2,-9,1,2,0,0,0],[-2,-10,1,2,0,0,0],[-2,-9,0,0,0,0,0],[-2,-11,0,2,0,0,0],[-1,-4,1,1,0,0,0],[-2,-1,1,2,0,0,0]
     ]
    );
  }

  function Unwrap(jsonStr) {
    if (!jsonStr) {
      return;
    }
    let json = JSON.parse(jsonStr);
    if (navigator.userAgent.indexOf("Safari")!== -1 && navigator.userAgent.indexOf("Chrome")=== -1) {
      if (json.tiles.length>254) {
        json.tiles.length=254;
      }
    } else if (navigator.userAgent.indexOf("Firefox")!== -1 && navigator.userAgent.indexOf("Chrome")=== -1) {
      if (json.tiles.length>157) {
        json.tiles.length=157;
      }
    }
    json.tiles.map(t => {
      if (t[6] > 1) {
        t[6] = 0;
      }
    });
    return JSON.stringify(json);
  }

  function Unlock(jsonStr) {
    if (!jsonStr) {
      return;
    }
    let json = JSON.parse(jsonStr);
    json.tiles.map(t => {
      t[6] = 0;
    });
    return JSON.stringify(json);
  }

  function moveMode() {
    document.body.classList.add('move');
    t3puzzle.setAttribute('mode', 'readonly');
    HISTORY.status = 'move';
  }

  function historyback() {
    if (HISTORY.back) {
      t3puzzle.setAttribute('loaddata', HISTORY.back);
    }
  }
  function clearall() {
    if (window.matchMedia && window.matchMedia('(max-device-width: 640px)').matches) {
      t3puzzle.setAttribute('loaddata', JSON.stringify({
        'meta': {
          'id': '',
          'base': '',
          'origin': '',
          artist: '_',
          'title': 'おなじむきにちがうもようでならべよう',
          'note': '６しゅるいのおきかたをぜんぶためしてみよう!'
        }, "orientation":2.0919229374524506,
        "tiles":[[0,-3,1,1,1,0,0],[0,-1,1,1,0,0,0]]
      }));
    } else {
      t3puzzle.setAttribute('loaddata', JSON.stringify({
        'meta': {
          'id': '',
          'base': '',
          'origin': '',
          artist: '_',
          'title': 'おなじむきにちがうもようでならべよう',
          'note': '６しゅるいのおきかたをぜんぶためしてみよう!'
        }, "orientation":2.0919229374524506,
        "tiles":[[0,-8,1,1,1,0,0],[0,-1,1,1,0,0,0]]
      }));
    }
  }
  function processData(value) {
    localStorage.setItem('DEBUG', JSON.stringify(
      value.detail.debug));
    let str = JSON.stringify(value.detail.value);
    HISTORY.back =
      localStorage.getItem(APP.name + '__DATA__LASTMODIFIED');
    localStorage.setItem(APP.name + '__DATA__LASTMODIFIED', str);
    HISTORY.status = 'change';
  }

  function dialogopen(action, modal, t3work, form, OBJ) {
    let school=false;
    let submit = form.querySelector('input[type=submit]');
    let age = form.querySelector('input[name=age]');
    let filename = form.querySelector('input[name=filename]');
    let artist = form.querySelector('input[name=artist]');
    let title = form.querySelector('input[name=title]');
    let data = form.querySelector('input[name=data]');
    let note = form.querySelector('textarea[name=note]');
    let jsonStr = '';
    if (action === 'load') {
      load__history.style.display = 'inline-block';
      load__title.style.display = 'inline-block';
      load__note.style.display = 'inline-block';
      let {
        str,
        i
      } = loadData(modal);
      jsonStr = str;
      setStrToForm(form, jsonStr, i);
    } else if (action === 'download') {
      load__history.style.display = 'none';
      load__title.style.display = 'none';
      load__note.style.display = 'none';
      goto(t3work, form, OBJ.jsonStr, null);
    } else {
      //  
      dialog__src.style.display = 'block';
      dialog__img.style.display = 'none';
      //
      jsonStr = localStorage.getItem(APP.name +
        '__DATA__LASTMODIFIED');
      jsonStr = Unwrap(jsonStr);
      setmeta();
      markArtist();
      let artistStr = localStorage.getItem(APP.type + '__INFO--ARTIST');
      if (artistStr) {
        artist.value = artistStr;
      }
      let ageStr = localStorage.getItem(APP.type + '__INFO--AGE');
      if (ageStr) {
        age.value = ageStr;
      }
      data.value = jsonStr;
      title.value = UPLOAD.title;
      if (!title.value) {
        let placeholder = UPLOAD.placeholder;
        if (placeholder) {
          title.placeholder = 'だいめい(れい)：' + placeholder;
        }
      }
      note.value = UPLOAD.note;
      jsonStr = Unlock(jsonStr);
      let inputage = dialog__form.querySelector('input[name="age"]');
      let inputtitle = dialog__form.querySelector('input[name="title"]');
      let inputemail = dialog__form.querySelector('input[name="email"]');
      let classemail = dialog__form.querySelector('div.email');
      let classselect = dialog__form.querySelector('div.classselect');
      let classunique = document.querySelector('div.classunique');
      let inputgrade = dialog__form.querySelector('select[name="grade"]');
      let inputgroup = dialog__form.querySelector('select[name="group"]');
      let inputindex = dialog__form.querySelector('select[name="index"]');
      if (location.search) {
        inputage.required = false;
        inputtitle.required = false;
        inputemail.value = '';
        
        classemail.style.display = 'none';
        if (/0x0x$/.test(location.search)) {
          classselect.style.display = 'none';
          classunique.style.display = 'block';
          updateEmailByUnique(dialog__form);
          inputgrade.required = false;
          inputgroup.required = false;
          inputindex.required = false;
        } else {  
          classselect.style.display = 'block';
          classunique.style.display = 'none';
          updateEmailBySelect(dialog__form);
          inputgrade.required = true;
          inputgroup.required = true;
          inputindex.required = true;
        }
        if (inputemail.value==="") {
          if (/0([1-6])0([0-6a-f])$/.test(location.search)) {    
            inputgrade.value = RegExp.$1;  
            inputgroup.value = RegExp.$2;
            if (RegExp.$2==="0") {
              inputgroup.value = "";
            }
          }
        } else {
          school = true;
          console.log(inputemail.value);
        }
      } else {
        inputage.required = true;
        inputtitle.required = true;
        inputemail.value = '';
        classemail.style.display = 'block'; // for contest
        classselect.style.display = 'none';
        classunique.style.display = 'none';
        inputgrade.required = false;
        inputgroup.required = false;
        inputindex.required = false;
      }
    }
    if (jsonStr) {
      t3work.setAttribute('loaddata', jsonStr);
    }
    if (!OBJ.submitMessage) {
      OBJ.submitMessage = submit.value;
      OBJ.submitEvent = form.getAttribute('onsubmit');
    } else {
      submit.value = OBJ.submitMessage;
      form.setAttribute('onsubmit', OBJ.submitEvent);
      submit.removeAttribute('disabled');
    }
    if (school) {
      if (/0([1-6])0([0-6a-f])$/.test(location.search)) {
        updateEmailBySelect(dialog__form);
      } else if (/0x0x$/.test(location.search)) {
        updateEmailByUnique(dialog__form);
      }
    }
    modal.setAttribute('open', '');
  }

  function loadData(modal) {
    let {
      min,
      max
    } = getCountFromLocal();
    if (min === null) {
      return '';
    }
    let initpointer = max;
    if (LOAD.pointer !== null) {
      initpointer = LOAD.pointer;
    }
    let {
      str,
      i
    } = loadDataFromLocal(initpointer, false);
    LOAD.data = str;
    return {
      str,
      i
    };
  }

  function loadDataToMain(modal, form) {
    t3puzzle.setAttribute('loaddata', LOAD.data);
    UPLOAD.placeholder = load__title.value;
    console.log(LOAD.data);
    modal.setAttribute('close', '');
  }

  function setStrToForm(form, str, idx) {
    putmeta(str);
    setmeta();
    let title = form.querySelector('input[name=title]');
    let note = form.querySelector('textarea[name=note]');
    title.value = '';
    note.value = '';
    if (str) {
      let json = JSON.parse(str);
      if (json.meta.title) {
        title.value = json.meta.title;
      }
      if (json.meta.note) {
        note.value = json.meta.note;
      }
      if (idx !== null) {
        let {
          min,
          max
        } = getCountFromLocal();
        let base = max - min + 1;
        let now = idx - min + 1;
        LOAD.pointer = idx;
        load__number.textContent = (now) + '/' + (base);
      }
    }
  }

  function backward(item, form) {
    let idx = LOAD.pointer;
    let {
      str,
      i
    } = loadDataFromLocal(idx - 1, false);
    goto(item, form, str, i);
  }

  function forward(item, form) {
    let idx = LOAD.pointer;
    let {
      str,
      i
    } = loadDataFromLocal(idx + 1, true);
    goto(item, form, str, i);
  }

  function gohead(item, form) {
    let {
      min,
      max
    } = getCountFromLocal();
    let {
      str,
      i
    } = loadDataFromLocal(min, false);
    goto(item, form, str, i);
  }

  function goend(item, form) {
    let {
      min,
      max
    } = getCountFromLocal();
    let {
      str,
      i
    } = loadDataFromLocal(max, true);
    goto(item, form, str, i);
  }

  function goto(item, form, str, i) {
    if (str) {
      setStrToForm(form, str, i);
      LOAD.data = str;
      item.setAttribute('loaddata', str);
    }
  }

  function loadDataFromLocal(idx, direct) {
    let {
      min,
      max
    } = getCountFromLocal();
    let i = idx;
    let str = '';
    while (min !== null && min <= i && i <= max) {
      str = localStorage.getItem(
        APP.name + '__DATA__' + i);
      if (str) {
        LOAD.pointer = i;
        break;
      }
      if (direct) {
        i++;
      } else {
        i--;
      }
    }
    if (!str) {
      if (direct) {
        LOAD.pointer = max;
      } else {
        LOAD.pointer = min;
      }
    }
    return {
      str,
      i
    };
  }

  function getCountFromLocal() {
    let maxStr = localStorage.getItem(
      APP.name + '__MAX');
    let minStr = localStorage.getItem(
      APP.name + '__MIN');
    let min = null;
    let max = -1;
    if (minStr) {
      min = parseInt(minStr, 10);
    }
    if (maxStr) {
      max = parseInt(maxStr, 10);
    }
    return {
      min,
      max
    };
  }

  function addDataToLocal(form) {
    let data = form.querySelector(
      'input[name=data]').value;
    if (!data) {
      return;
    }
    let title = form.querySelector(
      'input[name=title]').value;
    let note = form.querySelector(
      'textarea[name=note]').value;
    // count up
    let {
      min,
      max
    } = getCountFromLocal();
    let count = max + 1;
    let json = JSON.parse(data);
    if (!('meta' in json)) {
      json.meta = {};
    }
    json.meta.title = title;
    json.meta.note = note;
    localStorage.setItem(
      APP.name + '__DATA__' +
      count, JSON.stringify(json));
    localStorage.setItem(
      APP.name + '__MAX', count);
  }

  function submitImage(src, form, OBJ) {
    let submit = form.querySelector('input[type=submit]');
    let age = form.querySelector('input[name=age]');
    let filename = form.querySelector('input[name=filename]');
    let artist = form.querySelector('input[name=artist]');
    let content = form.querySelector('input[name=content]');
    let dataStr = form.querySelector('input[name=data]').value;
    submit.disabled = 'disable';
    if (submit.value==='ほぞんする') {
      submit.value = 'ほぞんちゅう';
    } else {
      submit.value = 'おうぼちゅう';
    }
    
    setTimeout(()=>{
    addDataToLocal(form);
    localStorage.setItem(APP.type + '__INFO--AGE', age.value);
    saveImage(src, dataStr, OBJ, (value) => {
      // image
      dialog__src.style.display = 'none';
      dialog__img.style.display = 'block';
      dialog__img.src = 'data:image/png;base64,'+value;
      //
      filename.value = 'server_to_be_named.png';
      content.value = value;
      try {
        fetch_upload(form, OBJ,
          (json) => {
            submit.removeAttribute('disabled');
            if (false) {
              submit.value = 'ツイート';
              let title = UPLOAD.title;
              let note = UPLOAD.note;
              let hash = '#FMS特別講義 #T3パズル';
              let url = 'https://drive.google.com/file/d/' + json.meta.image + '/view';
              let array = [title, note, hash, url];
              let tweet = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(array.join('\n'));
              form.setAttribute('onsubmit', `document.querySelector("#"+this.id+"__modal").setAttribute("close","");window.open("${tweet}");return false;`);
            } else {
              submit.value = 'とじる';
              form.setAttribute('onsubmit', 'document.querySelector("#"+this.id+"__modal").setAttribute("close","");return false;');
            }
            UPLOAD.title = '';
            UPLOAD.note = '';
            let data = JSON.parse(dataStr);
            data.meta = json.meta;
            history.replaceState('', '', '#!load=' + data.meta.id);
            let str = JSON.stringify(data);
            putmeta(str);
            localStorage.setItem(APP.name + '__DATA__LASTMODIFIED', str);
          }, (e) => {
            console.log(e);
            submit.value = '😨';
          }
        );
      } catch (e) {
        submit.value = '😨';
        console.log(e);
      }
    }, () => {
      submit.value = '🤔';
    })
  },0);
  }

  function fetch_initdata() {
    if (/#!history=(\d+)/.test(location.href)) {
      let val = parseInt(RegExp.$1, 10);
      let minStr = localStorage.getItem(APP.name + '__MIN');
      if (minStr) {
        let min = parseInt(minStr, 10);
        let num = val + min - 1;
        let jstr = localStorage.getItem(APP.name + '__DATA__' + num);
        if (jstr) {
          dialogopen('download', load__form__modal, load__t3work, load__form, {
            jsonStr: jstr
          });
        }
      }
    } else if (/#!load=([^\?#]+)/.test(location.href)) {
      let id = RegExp.$1;
      let url = UPLOAD.url + '?id=' + encodeURIComponent(id);
      console.log(url);
      fetch(url, {
          method: 'GET',
          mode: 'cors',
          redirect: 'follow',
        })
        .then(r => r.text())
        .then(jstr => {
          dialogopen('download', load__form__modal, load__t3work, load__form, {
            jsonStr: jstr
          });
        });
    }
  }

  function fetch_upload(form, OBJ, successCallback, errorCallback) {
    const body = new FormData(form);
    fetch(OBJ.url, {
        method: 'POST',
        body: body,
        mode: 'cors',
        redirect: 'follow',
      })
      .then(r => r.json())
      .then(j => {
        if (successCallback) {
          successCallback(j);
        }
      }).catch(e => {
        if (errorCallback) {
          errorCallback(e);
        }
      });
  }

  function saveImage(src, dataStr, OBJ, successCallback, errorCallback) {
    (async () => {
      try {
        domtoimage.toPng(src).then(dataurl=>{
          let txt = (dataurl.split(',')[1]);
          let buf = buffer.Buffer.from(txt, 'base64');
          let json = JSON.parse(dataStr);
          delete json.meta;
          let metadata = {
            "tEXt": {
              "meta": JSON.stringify(json)
            }
          };
          let bufwithmeta = writeMetadata(buf, metadata);
          let b64 = bufwithmeta.toString('base64');
          successCallback(b64);
        });
                                   
      } catch (e) {
        console.log('e::' + e);
        errorCallback();
      }
    })();
  }

  function markArtist() {
    let artist = localStorage.getItem(APP.type + '__INFO--ARTIST');
    if (!artist) {
      localStorage.setItem(APP.type + '__INFO--ARTIST', Math.random().toString(32).substring(2));
    }
  }

  function rotate(_item) {
    let item = _item ? _item : t3puzzle;
    if (!_item) {
      if (HISTORY.status !== 'rotate') {
        item.setAttribute('fit', '');
      }
    }
    item.setAttribute('rotate', Math.PI / 6);
    HISTORY.status = 'rotate';
  }

  function zoom(_item) {
    let item = _item ? _item : t3puzzle;
    item.setAttribute('zoom', 0.9);
  }

  function bodyMovePrevent() {
    document.addEventListener('touchmove', e => e.preventDefault(), {
      passive: false
    });
    document.addEventListener('mousewheel', e => e.preventDefault(), {
      passive: false
    });
  }
</script>
<script src="https://www.t3puzzle.com/b/tapspace.min.js"></script>
<script src="https://www.t3puzzle.com/b/dom-to-image.min.js"></script>
<script src="https://www.t3puzzle.com/b/buttonText.js"></script>
<script src="https://www.t3puzzle.com/b/palleteText.js"></script>
<script src="https://www.t3puzzle.com/b/dialog-modal.js"></script>
<script src="https://www.t3puzzle.com/b/switch-text.js"></script>
  
<script src="./t3.js"></script>
<noscript><iframe width="600" height="1000" src="./support.html"></iframe></noscript>
</body>
</html>

