<!DOCTYPE html>
<html>
<head>
    <title>SVG Manipulation with Multitouch</title>
    <style>
        #mySVG {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <svg id="mySVG" width="100%" height="100%">
	<g id="s_coord">
        <rect id="myRect" x="150" y="150" width="200" height="200" fill="yellow" />
	</g>
        <rect id="s_marker" x="0" y="0" width="20" height="20" fill="red" />

    </svg>

    <script>
        var svg = document.getElementById('mySVG');
        var rect = document.getElementById('myRect');

        svg.setAttribute('width', window.innerWidth);
        svg.setAttribute('height', window.innerHeight);

        var initialDistance = 0;
        var initialAngle = 0;
        var initialX = 0;
        var initialY = 0;
	var coordInitialX = 0;
	var coordInitialY = 0;
	var coordInitialAngle = 0;
        var coordInitialScale = 1;

        svg.addEventListener('touchstart', function(event) {
            if (event.touches.length == 2) {
                var dx = event.touches[1].pageX - event.touches[0].pageX;
                var dy = event.touches[1].pageY - event.touches[0].pageY;
                initialDistance = Math.sqrt(dx * dx + dy * dy);
                initialAngle = Math.atan2(dy, dx);
                initialX = (event.touches[0].pageX + event.touches[1].pageX) / 2;
                initialY = (event.touches[0].pageY + event.touches[1].pageY) / 2;
		let m = s_coord.getScreenCTM();
		let MA = m.a-initialX;
		let MB = m.b-initialX; 
		let ME = initialX*(m.a-initialX)+initialY*(m.b-initialX)-initialX + m.e;
		let MF = initialY*(m.d-initialY)+initialX*(m.d-initialX)-initialY + m.f;
		coordInitialX = ME; 
		coordInitialX = MF; 
		coordInitialScale = MA;
		coordInitialAngle = Math.atan2(MB, MA) * (180 / Math.PI);
            }
        });

        svg.addEventListener('touchmove', function(event) {
            event.preventDefault();
            if (event.touches.length == 2) {
                var xCenter = (event.touches[0].pageX + event.touches[1].pageX) / 2;
                var yCenter = (event.touches[0].pageY + event.touches[1].pageY) / 2;

                var dx = event.touches[1].pageX - event.touches[0].pageX;
                var dy = event.touches[1].pageY - event.touches[0].pageY;
                var distance = Math.sqrt(dx * dx + dy * dy);
                var angle = Math.atan2(dy, dx);

                var scale = coordInitialScale * distance / initialDistance;
                var rotate = coordInitialAngle + (angle - initialAngle) * 180 / Math.PI;

		var x = coordInitialX + xCenter - initialX;
		var y = coordInitialY + yCenter - initialY;

                s_coord.setAttribute('transform', `translate(${x},${y}) translate(${xCenter},${yCenter}) scale(${scale}) rotate(${rotate}) translate(${-xCenter},${-yCenter})`);
                s_marker.setAttribute('transform', `translate(${xCenter},${yCenter})translate(${xCenter},${yCenter})scale(${ distance / initialDistance})rotate(${(angle - initialAngle) * 180 / Math.PI})translate(${-xCenter},${-yCenter})`);
            }
        });

        svg.addEventListener('touchend', function(event) {
            if (event.touches.length == 1) {
                initialDistance = 0;
                initialAngle = 0;
            }
        });
    </script>
</body>
</html>
