<div class="menu">
<pallete-text  id="mode" onchange="t3puzzle.setAttribute('mode', this.value);" value="hand">
  <datalist>
    <option value="readonly">⤧</option>
  
    <option value="anchor">⚓</option>  <option disabled></option>
    <option value="lock">🔒</option>
     <option value="hand">👆</option>
  </datalist>
</pallete-text>

<pallete-text  id="nomoveall" onchange="t3puzzle.setAttribute('nomoveall', this.value);">
  <datalist>
    <option value="nomoveall">x</option>
  </datalist>
</pallete-text>
<pallete-text  id="noflipall" onchange="t3puzzle.setAttribute('noflipall', this.value);">
  <datalist>
    <option value="noflipall">x</option>
  </datalist>
</pallete-text>
<pallete-text onchange="if(this.value) {mode.setAttribute('value', '');t3puzzle.setAttribute('color', this.value);}">
  <datalist>
    <option value="blue"></option>
    <option value="green"></option>
    <option disabled></option>
    <option value="pink"></option>
    <option value="mint"></option>
  </datalist>
</pallete-text>
  <br/>
   <button-text text="➰" onclick="t3puzzle.setAttribute('flipall','');" size="40px">
  </button-text>
  <button-text text="👁" onclick="t3puzzle.setAttribute('fit','');" size="40px">
  </button-text>

   <button-text text="⤿"
                      onclick="rotate();" size="40px">
  </button-text>
  <br/>
   <button-text text="📖"
                      onclick="loadData();" size="40px">
  </button-text>

   <button-text text="🔖"     onclick="saveData()" size="40px">
</button-text>
  
    <button-text text="📝"     onclick="console.log(1);" size="40px">
</button-text>
   <button-text text="↤"     onclick="backward();" size="40px">
</button-text>
  <button-text text="↦"     onclick="forward();" size="40px">
</button-text>
</div>
<grid-puzzle style="margin-left:0px;" id="t3puzzle" onChange="processData(this.value)">
  <datalist>
    <grid-data>{
"orientation":2.094388031086739,
"tiles":[[0,0,0,0,0,0,1],[0,0,1,0,0,0,1],
      [1,0,0,0,0,0,0],[1,0,1,0,0,0,0],[2,0,1,2,1,0,0]]}
    </grid-data>
  </datalist>
</grid-puzzle>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.0.0-rc.5/dist/html2canvas.min.js"></script>
<script>
  
  let HISTORY = {
    max: 200,
    count: -1,
    pointer: -1,
    status: ''
  };
  let SAVE = {
    max: 10,
  }
  function rotate( ) {   

   if (HISTORY.status!=='rotate') {
    t3puzzle.setAttribute('fit','');
   }
   t3puzzle.setAttribute('rotate',Math.PI/3);
   HISTORY.status = 'rotate';
  }
  function emptyIndexFromLocalStorage(){
    let dates=[];
    let empty=[];
    let dihash = {};
    for (let i=0;i<SAVE.max;i++) {
      let item = localStorage.getItem('t3puzzle__DATA--'+i);
      
      if (!item) {
        return i;
      } else {
        try {
          let json = JSON.parse(item);
	  let date = json.date;
	  dates.push(date);
          dihash[date] = i;
        } catch (e) {
          return i;
        }
      }
    }
    if(dates.length===SAVE.max) {
      dates.sort();
      return dihash[dates[0]];
    }
  }
  function scanLocalStorage(){
    let MAX = 10;
    let dates=[];
    let ddhash = {};
    for (let i=0;i<SAVE.max;i++) {
      let item = localStorage.getItem('t3puzzle__DATA--'+i);
      if (!item) {
        continue;
      } else {
        try {
          let json = JSON.parse(item);
	        let date = json.date;
          ddhash[date] = json.data;
        } catch (e) {
          continue;
        }
      }
    }
    return ddhash;
  }
  function processData(value) {localStorage.setItem('DEBUG',JSON.stringify(
      value.detail.debug));
    
    let firstloaded = localStorage.getItem('t3puzzle__DATA--FIRSTLOADED');
    let str = JSON.stringify(value.detail.value);
    if (!firstloaded || HISTORY.count===-1) {
      localStorage.setItem('t3puzzle__DATA--FIRSTLOADED',str);
    } else {
      localStorage.setItem('t3puzzle__DATA--LASTMODIFIED',str);
    }
                               
    if (HISTORY.status!=='history') {
      let json = JSON.parse(str);
      delete json.orientation;
      HISTORY.pointer++;
      HISTORY.count = HISTORY.pointer;
      localStorage.setItem('t3puzzle__DATA--HISTORY'+HISTORY.count,JSON.stringify(json));
    }
    HISTORY.status = 'change'; 
    
  }
  function loadData(){
    let selected = null; 
    let saved = localStorage.getItem('t3puzzle__DATA--LASTSAVED');
    let firstloaded = localStorage.getItem('t3puzzle__DATA--FIRSTLOADED');
    let lastmodified = localStorage.getItem('t3puzzle__DATA--LASTMODIFIED');

    if (saved){
      console.log('load saved');
      selected = saved;
    } else if (HISTORY.count>1 && firstloaded) {
      
      console.log('load firstloaded:'+HISTORY.count);
      selected = firstloaded;
       
    } else if (lastmodified) {
        console.log('load lastmodified');
        selected = lastmodified;
    } else if (firstloaded) {
      
      console.log('load firstloaded:000');
      selected = firstloaded; 
    } else {
        console.log('load none');
        selected = '{ "tiles": []}';
     
    }
    t3puzzle.setAttribute('loaddata',selected);
    localStorage.setItem('t3puzzle__DATA--LASTLOADED',selected);
    let ddhash = scanLocalStorage();
    let sort=[];
    for (let key in ddhash) {
      sort.push(key);
      //console.log(key+' '+ddhash[key]);
    }
    sort.sort();
    sort.map(k=>{
      console.log(k+' '+ddhash[k]);
    });
  }
  function saveData () { 
    let lastmodified = localStorage.getItem('t3puzzle__DATA--LASTMODIFIED');
    if (!lastmodified) {
      return;
    }
    let lastsaved = localStorage.getItem('t3puzzle__DATA--LASTSAVED');
    if (lastmodified != lastsaved) {
      let idx = emptyIndexFromLocalStorage();
      
      let value = {
        date: Date.now(),
        data: JSON.parse(lastmodified)
      };
      localStorage.setItem('t3puzzle__DATA--'+idx,JSON.stringify(value));
      localStorage.setItem('t3puzzle__DATA--LASTSAVED',lastmodified);
    }
  }
  function backward () {
    if (HISTORY.pointer <= 0) { return; }
 
    HISTORY.status = 'history';
    HISTORY.pointer--;
    console.log(HISTORY.pointer);
    let str = localStorage.getItem('t3puzzle__DATA--HISTORY'+HISTORY.pointer);
    if (str) {
      t3puzzle.setAttribute('loaddata',str);
    }
  }
  function forward () {
    if (HISTORY.pointer >= HISTORY.count) { return; }
    
    HISTORY.status = 'history';
    HISTORY.pointer++;
    console.log(HISTORY.pointer);
    let str = localStorage.getItem('t3puzzle__DATA--HISTORY'+HISTORY.pointer);
    if (str) {
      t3puzzle.setAttribute('loaddata',str);
    }
  }
  /*
  // alternative change event
  let t3puzzle = document.getElementById('t3puzzle');
  t3puzzle.addEventListener('change',e=>{
    console.log(e.detail.state);
  });
  */
</script>
<script src="https://unpkg.com/tapspace@1.2.0/dist/tapspace.min.js"></script>
<script src="https://www.t3puzzle.com/b/buttonText.js"></script>
<script src="https://www.t3puzzle.com/b/palleteText.js"></script>
