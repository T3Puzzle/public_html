<!DOCTYPE html>
<html>
<head>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
</head>
<body style="text-size-adjust:100%;">
<script>
(()=>{
let urls = [
{'sample':'https://script.google.com/a/tessellation.jp/macros/s/AKfycbyBDZgDsEQES4qcydyUI9G-1LF-huzbf62J1YV2/exec'},
//{'sample':'https://script.google.com/macros/s/AKfycbz59zmsVf6XS4eCOIg26TnjcxiSQmfqc2Obc17iEsl6VcziOPkf/exec'},
]; 
let me=document.currentScript;
let name='svgconfig';
me.insertAdjacentHTML('afterend',`<output class="${name}" style="position:fixed;background-color:#dddddd;"></output>`);
document.addEventListener('DOMContentLoaded',()=>{
   document.body.querySelector(`output.${name}`).insertAdjacentHTML('beforeend',getHtml());
});
function getHtml() {
  let hidden = 'style="display:none;"';
  let options = [''];
  if (urls.length===1) {
    for(let uk in urls[0]) {
      options.push(`<option value="${urls[0][uk]}" selected></option>`);
    }
  } else if (urls.length>1) {
    hidden = '';
    for(let ui=0;ui<urls.length;ui++) {
      for(let uk in urls[ui]) {
        options.push(`<option value="${urls[ui][uk]}">${uk}</option>`);
      }
    }
  }
  return `<select name="${name}" ${hidden} style="vertical-align:0.6em;margin-left:0.5em;">${options.join('')}</select>`; 
}
})();
</script>
<script>
(()=>{
let config='svgconfig';
let output='svgoutput';
let me=document.currentScript;
let name='svginput';
me.insertAdjacentHTML('afterend',`<output class="${name}"></output>`);
document.addEventListener('DOMContentLoaded',()=>{
  let configoptions = document.body.querySelectorAll(`output.${config} select option`);
  if (configoptions.length>0) {
    return;
  }
  let output = document.body.querySelector(`output.${name}`);
  output.insertAdjacentHTML('beforeend',`<input name="${name}" type="file" accept=".svg">`);
  let input = document.querySelector(`input[name=${name}]`);
  input.addEventListener('change',()=>{ 
    let fr=new FileReader(); 
    fr.addEventListener('load',()=>
      document.body.querySelector(`output.${output}`).innerHTML = fr.result);
    fr.readAsText(input.files[0]); 
  });
});
})();
</script>
<script>
(()=>{
let dblclickTimeout = 300;
let height=30;
let width=600;
let head=15;
let colors = [
  {'basic':['#000000','#ffffff','#ff0000','#00ff00','#0000ff','#ffff00', '#00ffff','#ff00ff']},
//  {'dark':['#333333','#aaaaaa','#aa3333','#33aa33','#3333aa','#aaaa33', '#33aaaa','#aa33aa']},
];
let colorType = null;
let radius= null;
let padding= null;
let picker = null;
let svg=null;
let me=document.currentScript; 
let name='svgpick';
let config='svgconfig';
let svgoutput='svgoutput';
me.insertAdjacentHTML('afterend',`<output class="${name}"></output>`);
document.addEventListener('DOMContentLoaded',()=>{
  let output = document.body.querySelector(`output.${config}`);
  let select = getSelect();
  output.insertAdjacentHTML('beforeend',`
${select}
<input class="${name}" type="color" value="#ff0000"  style="vertical-align:0.3em;margin-left:0.5em;margin-top:0.3em;">
<svg class="${name}" width="${width}" height="${height}" style="vertical-align:-0.2em;"></svg>
  `);
  svg = document.body.querySelector(`output.${config} svg.${name}`);
  initCircles();
  picker = document.body.querySelector(`input.${name}`);
  // TODO: addCircle when actually used.
  picker.addEventListener('change',event=>addCircle(conv(event.target.value)));
  selector = document.body.querySelector(`select.${name}`);
  if (selector) {
    selector.addEventListener('change',event=>{
      colorType = event.target.value;
      initCircles();
    });
  }
});
function initCircles() {
  svg.innerHTML = '';
  let cols = getCols();
  for(let ci=0;ci<cols.length;ci++) {
    addCircle(conv(cols[ci]));
  }
}
function getSelect() {
  if (colors.length<=1){
    return '';
  }
  let opt=[];
  for(let ci=0;ci<colors.length;ci++) {
    for(let ck in colors[ci]) {
      opt.push(`<option value="${ck}">${ck}</option>`);
      continue;
    }
  }
  return `<select class="${name}" style="vertical-align:0.6em;margin-left:0.5em;"><`+opt.join('')+'</select>';
}
function getCols() {
  if (colorType) {
    for(let ci=0;ci<colors.length;ci++) {
      for(let ck in colors[ci]) {
        if (ck===colorType) {
          return colors[ci][ck];
        }
      }
    }
  }
  if (colors.length>0) {
    for(let ck in colors[0]) {
      return colors[0][ck];
    }
  } else {
    return ['#000000','#ffffff'];
  }
}
function conv(val) {
  if (val.indexOf('#')===0) {
    return val.toLowerCase();
  } else if (val.indexOf('rgb')===0) {
     let vals = val.replace(/rgb\s*\(/,'').replace(/\s*\)\s*/,'').split(',');  
     let r = parseInt(vals[0],10).toString(16).toLowerCase();
     let g = parseInt(vals[1],10).toString(16).toLowerCase();
     let b = parseInt(vals[2],10).toString(16).toLowerCase();
     if (r.length!==2) { r='0'+r;}
     if (g.length!==2) { g='0'+g;}
     if (b.length!==2) { b='0'+b;}
     return '#'+r+g+b;
  }
}
function addCircle(color) {
  if (checkColorDup(color)){
    return;
  }
  let cmax = getCircleCount();
  if (cmax > 15 ) {
    return;
  }
  radius = height*0.8/2;
  padding = radius*0.3;
  let cx = getCx(cmax);
  let id = 'c'+color.replace('#','');
  svg.insertAdjacentHTML('beforeend',`<circle r="${radius}" cy="${radius+padding}" cx="${cx}" style="fill:${color};" class="${name}" id="${id}">`);
  svg.querySelector(`circle#${id}`).addEventListener('click',processClick);
}
let pendingClick=0;
let backupColor=null;
function processClick (e) {
  if (pendingClick) {
    window.clearTimeout(pendingClick);
    pendingClick=0;
  } 
  if(e.detail === 1){
    backupColor = conv(picker.value);
    pendingClick=window.setTimeout(()=>{
    },dblclickTimeout);
    picker.value = conv(e.target.style.fill);
  } else if (e.detail === 2) {
    picker.value = backupColor;
    let fill = conv(e.target.style.fill);
    if (fill==='#000000' || fill==='#ffffff') {
      return;
    }
    e.target.remove();
    rearrangeCircles();
  }
}
function getCx(index) {
  return (2*radius+padding)*(index+1);
}
function rearrangeCircles() {
  let circles = document.body.querySelectorAll(`output.${config} svg.${name} circle.${name}`);
  for (let ci=0;ci<circles.length;ci++) {
    circles[ci].setAttribute('cx',getCx(ci));
  }
}
function checkColorDup(color) {
  let circles = document.body.querySelectorAll(`output.${config} svg.${name} circle.${name}`);
  for (let ci=0;ci<circles.length;ci++) {
    if (conv(circles[ci].style.fill)===color) {
      return true;
    }
  }
  return false;
}
function getCircleCount() {
  let circles = document.body.querySelectorAll(`output.${config} svg.${name} circle.${name}`);
  if (!circles) {
    return 0;
  } else {
    return circles.length;
  }
}
})();
</script>
<script>
(()=>{
let once=0;
let download=null;
let filename=null;
let config='svgconfig';
let svgoutput='svgoutput';
let me=document.currentScript;
let name='pngdownload';
me.insertAdjacentHTML('afterend',`<output class="${name}"></output>`);
document.addEventListener('DOMContentLoaded',()=>{
  let output = document.body.querySelector(`output.${config}`);
  output.insertAdjacentHTML('beforeend',`
<a class="${name}" style="vertical-align:0.2em;font-size:120%;margin-right:0.5em;">⬇</a>
`);
  download = output.querySelector(`a.${name}`);
  filename = getFileName();
  download.href = '#';
  download.addEventListener('click', click,{passive:false});

});
function svgToImageData(svgElement, callback) {
  let canvas = document.createElement('canvas');
  canvas.width = svgElement.width.baseVal.value;
  canvas.height = svgElement.height.baseVal.value;
  let ctx = canvas.getContext('2d');
  let image = new Image();
  image.addEventListener('load',()=>{
    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
    let type = 'image/png';
    toBlob(canvas,callback,type);
  });
  image.addEventListener('error',e=>console.error(e));
  var svgData = new XMLSerializer().serializeToString(svgElement);
  // use of btoa
  image.src = 'data:image/svg+xml;charset=utf-8;base64,' + btoa(svgData);
}
function toBlob(canvas,callback,type) {
  //canvas.toBlob(callback,type);
  let dataurl = canvas.toDataURL(type);
  let bin = atob(dataurl.split(',')[1]);
  let buffer = new Uint8Array(bin.length);
  for (var i = 0; i < bin.length; i++) {
    buffer[i] = bin.charCodeAt(i);
  }
  let blob = new Blob([buffer.buffer], {type: type});
  callback(blob);
}
function click(e) {
  if (once===0) {
    e.preventDefault();
  }
  once++;
  download.download = filename + getDateStr() + '.png';
  let svgElement = document.body.querySelector(`output.${svgoutput} svg`);
  svgToImageData(svgElement, blob=>{
    e.target.href = window.URL.createObjectURL(blob);
    if (once===1) {
      window.setTimeout(()=>{
        e.target.click();
        window.setTimeout(()=>once=0,1000);
      },1000);
    }
  });
}
function getFileName() {
  let pathname = document.location.pathname;
  let name = '_';
  if (/([^\/]+)$/.exec(pathname)) {
    pathname = RegExp.$1;
    if (/^([^\?#.]+)/.exec(pathname)) {
       name = RegExp.$1;
    }
  }
  return name;
}
function getDateStr() {
  let date = new Date();
  let millisec = date.getMilliseconds();
  if (millisec<1) {
    millisec = '000';
  } else if (millisec<10) {
    millisec = '00'+millisec;
  } else if (millisec<100) {
    millisec = '0'+millisec;
  }
  let options = { year: 'numeric', month: '2-digit', day: '2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'};
  return date.toLocaleString('ja-JP',options).replace(/(\/|:)/g,'').replace(/ /g,'_')+'_'+millisec;
}
})();
</script>
<script>
(()=>{
let history=[];
let lastunredo=0;
let config='svgconfig';
let pick='svgpick';
let me=document.currentScript;
let name='svgoutput';
me.insertAdjacentHTML('afterend',`<output class="${name}"></output>`);
let output =null;
document.addEventListener('DOMContentLoaded',()=>{
  output = document.body.querySelector(`output.${name}`);
  let svgconfig = document.body.querySelector(`output.${config}`);
  let hidden = 'display:none;';
  svgconfig.insertAdjacentHTML('beforeend',`
<a class="undo" href="#" style="vertical-align:0.2em;font-size:120%;margin-right:0.5em;">↩</a>
<a class="redo" href="#" style="vertical-align:0.2em;font-size:120%;margin-right:0.5em;">↪</a>
<input class="${name}" type="range" width="100%" value="1" min="1" max="1"  style="${hidden}vertical-align:0.3em;margin-right:0.5em;">
`);
  let picker = document.body.querySelector(`output.${config} input.${pick}`);
  let unredo = document.body.querySelector(`output.${config} input.${name}`);
  let undo = document.body.querySelector(`output.${config} a.undo`);
  let redo = document.body.querySelector(`output.${config} a.redo`);
  output.addEventListener('click',event=>{
    if (unredo.max!==unredo.value) {
      history.length = unredo.value-1;
    }
    let id = getId(event.target);
    history.push({i:id, p:event.target.style.fill,n:picker.value});
    event.target.style.fill = picker.value;
    unredo.max = history.length+1;
    unredo.value = unredo.max;
    lastunredo = unredo.max;
  });
  unredo.addEventListener('change',event=>{
    let nowunredo = event.target.value;
    if (nowunredo===lastunredo) {
      // nop
    } else if (nowunredo<lastunredo) {
      for (let i=lastunredo-1;i>=nowunredo;i--) {
        processUndo(i);
      }
    } else if (nowunredo>lastunredo) {
      for (let i=lastunredo;i<nowunredo;i++) {
        processRedo(i);
      }
    }
  });
  undo.addEventListener('click',event=>processUndo(lastunredo-1));
  redo.addEventListener('click',event=>processRedo(lastunredo));
  let svgconfigselect = document.body.querySelector(`output.${config} select[name=${config}]`);
  let svgconfigopts = svgconfigselect.querySelectorAll('option');
  if (svgconfigopts.length===1) {
    loadSvg(getFirstUrl(svgconfigselect));
  } else if (svgconfigopts.length>1) {
    svgconfig.addEventListener('change',event=>
      loadSvg(e.target.value)
    );
  }
});
function processUndo(i) {
  if (history.length<i ||(i-1)<0) {
    return;
  }
  let h = history[i-1];
  let t = output.querySelector('#'+h.i);
  t.style.fill = h.p;
  lastunredo--;
}
function processRedo(i) {
  if (history.length<i ||(i-1)<0) {
    return;
  }
  let h = history[i-1];
  let t = output.querySelector('#'+h.i);
  t.style.fill = h.n;
  lastunredo++;
}
function getId(target) {
  let id = target.id;
  if (id) {
    return id;
  } else {
    target.id = 's'+new Date().getTime();
    return target.id;
  }
}
function getFirstUrl(svgconfigselect) {
  return svgconfigselect.querySelector('option').value;
}
function loadSvg(url) {
    fetch(url)
    .then(response => response.text())
    .then(svg => output.insertAdjacentHTML('beforeend',svg));
}
})();
</script>
</body>
</html>
